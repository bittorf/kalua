#!/bin/sh

# this outputs an inital small loader which can be sourced for each 'class', e.g. for class 'wifi':
#
# idee: methode 'unload' ?
# idee: methode help?
# idee: $FUNCNAME fuellen ODER alle Vorkommen von FUNCNAME durch realen zur "compile-zeit" ersetzen
# idee: passend zur klasse automatisch einen bestimmten variablensatz aktivieren (z.b. $INTRANET bei pfilter)?
# idee: statistik anzeigen lassen per befehl: sed -n "s/^\(.*\) ().*/\1/p" $BASEDIR/${CLASS} | wc -l | sed 's/ //g'
# idee: netparam ohne *MTU|BRC|OLSR|MSK|LO*
# todo: option zum entfernen aller logmeldungen? (bzw. nur log-debug)
# todo: lade-log an/aus (loader/realclass)

. $0.functions

IFS=". "; read UP1 UP2 NOP </proc/uptime; unset IFS

DEBUG="$1"			# keyword "debug" or empty
BASEDIR="/etc/kalua"		# scriptbase, simply throw your 'class'-files here e.g. wifi
LOADER="/tmp/loader_$$"
LOADER_FINAL="/tmp/loader"	# scripts can source this file and automatically use all 'classes'

if [ -d "${BASEDIR}.w" ]; then
	POOLDIR="${BASEDIR}.w"

	[ -e "$POOLDIR/CHECKSUMS" ] || {
		rm $POOLDIR/*

		if cat $BASEDIR/* >"$POOLDIR/spacetest"; then
			rm "$POOLDIR/spacetest"
		else
			rm -fR "$POOLDIR"
			POOLDIR="/tmp/kalua"
		fi
	}
else
	POOLDIR="/tmp/kalua"
fi

mkdir -p "$POOLDIR"

TIMEZONE_BERLIN="CET-1CEST,M3.5.0,M10.5.0/3"
TIMEZONE="$( uci get system.@system[0].timezone )"
TIMEZONE="${TIMEZONE:-$TIMEZONE_BERLIN}"

echo  >"$LOADER" "# generated by $0"
echo >>"$LOADER" "export TZ='$TIMEZONE'"
echo >>"$LOADER" "_(){ ls -1 $POOLDIR|sort|sed 's/^/_/';}"
# echo >>"$LOADER" "x(){ . $POOLDIR/\$1;}"			# safes 350 bytes in combination with [3], but i like the speedcode

for CLASS in $( find $BASEDIR -type f -name "[a-z]"* ); do {	# only include lowercase names

	CLASS="$( basename $CLASS )"				# generate loader and add methods 'show'+'include'

	MAX_ARGS="$( _kalua_max_arguments "$BASEDIR/$CLASS" )"

	[ "$DEBUG" = "debug" ] && {
		DEBUG1="logger -- working in _$CLASS, calling \$1 with args ${MAX_ARGS#* };"	# omit first ARG
		DEBUG2="logger -- including _$CLASS subfunc \$1;"
		DEBUG3="|| logger -t $CLASS -s \"invalid call: \$1\""
	}

	HASH="$( md5sum "$BASEDIR/$CLASS" )"
	HASH="${HASH%% *}"
	grep -qs "$CLASS $HASH" "$POOLDIR/CHECKSUMS" || {

		cat >"$POOLDIR/${CLASS}" <<EOF
_${CLASS}(){ ${DEBUG1}_${CLASS}_\${1:-s} ${MAX_ARGS#* }${DEBUG3};}
_${CLASS}_show(){ sed -n "s/\(_${CLASS}_.*\)()/\1/p" $BASEDIR/${CLASS}|sort ;}
_${CLASS}_s(){ _${CLASS}_show ;}
_${CLASS}_include(){ :;}
EOF

		# fixme! do it *fast* when booting, and then do it *good-but-slow* after booting
		_kalua_strip_script "$BASEDIR/$CLASS" "$CLASS" "$DEBUG" >>"$POOLDIR/${CLASS}"

		sed -i "/^$CLASS /d" "$POOLDIR/CHECKSUMS"	# remove maybe old checksum
		if sh -n "$POOLDIR/${CLASS}"; then
			echo "$CLASS $HASH" >>"$POOLDIR/CHECKSUMS"
		else
			DEBUG="compile_error"
		fi
	}

	case "$DEBUG" in
		compile_error)
			DEBUG=
			echo -en >>"$LOADER" "_${CLASS}(){ logger -s -- CLASSERROR: _$CLASS \$@ ;}\n"
		;;
		debug)
			. "$POOLDIR/${CLASS}"
			echo -en >>"$LOADER" "_${CLASS}(){ . $POOLDIR/$CLASS;${DEBUG2}_${CLASS} ${MAX_ARGS}${DEBUG3};}\n"
		;;
		*)
# [3]			echo -en >>"$LOADER" "_${CLASS}(){ _=${CLASS};x \$_;${DEBUG2}_\${_}_\${1:-s} ${MAX_ARGS#* };}\n"
			echo -en >>"$LOADER" "_${CLASS}(){ . $POOLDIR/$CLASS;${DEBUG2}_${CLASS}_\${1:-s} ${MAX_ARGS#* };}\n"
		;;
	esac
} done

if [ -e /tmp/NETPARAM ]; then		# fixme! better concept needed
	. /tmp/NETPARAM
	
	while read LINE; do {
		case "$LINE" in
			*"="*)
				echo >>"$LOADER" -n "${LINE};"
			;;
		esac
	} done </tmp/NETPARAM
	
	echo -en >>"$LOADER" "WIFI_DEVS=$WIFIDEV\n"
else
	logger -s "$0 could'nt work with '/tmp/NETPARAM'"
fi

[ -e "/etc/variables_fff+" ] && . /etc/variables_fff+
echo >>"$LOADER" "FFF_PLUS_VERSION=$FFF_PLUS_VERSION;FFF_VERSION=$FFF_VERSION"

get_homedir_from_passwd()
{
	grep -e ^"${USER:-root}:" /etc/passwd | cut -d ":" -f 6
}

echo >>"$LOADER" "export HOME=$( get_homedir_from_passwd )"

echo >>"$LOADER" "_uci() { return 1; }"		# till we remove all references to "_uci is_oldstyle()"

mv "$LOADER" "$LOADER_FINAL"
. "$LOADER_FINAL"			# fixme! rely on external functions _log + _file ?

echo -n "$WIFIDEV" >/tmp/WIFIDEV	# is a hack for fast seeking our dev/ip
echo -n "$WIFIADR" >/tmp/WIFIADR

IFS=". "; read UP3 UP4 NOP </proc/uptime; unset IFS
TIME="$(( $UP3$UP4 - $UP1$UP2 ))"
TIME="$( echo $TIME | sed 's/^\(.*\)\(..\)$/\1.\2/' )sec"	# 386ms -> 3.86sec

_log do gen_loader daemon info "[OK] done '$LOADER_FINAL' (in $TIME, using $( _file diskusage $POOLDIR ) bytes in $POOLDIR) - you MUST reinclude the new loader with '. $LOADER_FINAL' if this is an interactive shell"
