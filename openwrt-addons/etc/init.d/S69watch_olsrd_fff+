#!/bin/sh
. /tmp/loader		# this script runs ~ every 15 minutes

echo 1 >/proc/sys/net/ipv4/ip_forward

case "$( uci get wireless.radio0.macaddr )" in
	"00:15:6d:ad:5c:26")			# nanostation2 max (hardware-error)
		mii-tool 2>&1 | grep -q "link ok" || {
			for OPT in R "A 10baseT-HD" "F 10baseT-HD" r v ; do {
				sleep 3
				mii-tool -$OPT | _log do mii-tool daemon info
			} done
		}
	;;
esac

case "$( uci get wireless.radio0.htmode )" in
	HT40*)
		case "$( _wifi mode $WIFIDEV )" in
			ap)
				uci set wireless.radio0.htmode=HT20
				uci commit wireless
			;;
		esac
	;;
esac

_watch flash_free_space

_watch wifi_mode || sleep 30		# lets settle down to see some neighs

case "${CONFIG_PROFILE}" in
	rehungen*)			# etx 1.000 -> metric 4 -> but valid!
		case "$WIFIADR" in
			10.10.60.1|10.10.76.1)
				touch "/tmp/service_olsrd_nowatching"
			;;
		esac
	;;
esac

[ -e "/tmp/service_olsrd_nowatching" ] || {
	_olsr check_plausi || {
		_log do olsr_deepwatch daemon info "error during check_plausi, watching again in 65sec"

		sleep 65
		_olsr build_tables

		if _olsr check_plausi deep; then
			_log do olsr_deepwatch daemon info "[OK] no error on 2nd check"
		else
			_olsr daemon restart "plausi_check_failed"
		fi
	}
}

_watch system_time
_watch dns_resolution
_watch pppoe
_watch netserver
_watch sshd_or_telnet
_watch random_node_id
_watch dhcp_space

case "$CONFIG_PROFILE" in
	ffweimar*)
		:
	;;
	*)
		cron.add_collected_userdata_into_db

		_log sleep jitter_user_stats_process "$( _math random_integer 0 100 )" step 5
		_netfilter user_stats_process
	;;
esac

/usr/sbin/cron.reverse_ssh_tunnel

_firmware upgrade_is_needed && {
	touch /tmp/START_SYSUPGRADE
}

case "$CONFIG_PROFILE" in
	zumnorde*|adagio*|lisztwe*|apphalle*|fparkssee*|marinapark*|satama*|monami*|liszt28*|elephant*)
		case "$CONFIG_PROFILE" in
			*ap)
				case "$HOSTNAME" in
					SA-leuchtturm-AP|SA-restaurant-MESH)
					;;
					*)
						[ -n "$( uci get dhcp.@dnsmasq[0].dhcpscript )" ] && {
							uci delete dhcp.@dnsmasq[0].dhcpscript
							/etc/init.d/dnsmasq restart
						}
					;;
				esac

				[ -z "$( uci get olsrd.@meta[0].hnaslave )" ] && {
					_net local_inet_offer >/dev/null || uci set olsrd.@meta[0].hnaslave=1
				}
			;;
			*adhoc)
				[ $( _system ram_size ) -lt 16384 ] && {
					[ -e "/www/SIMPLE_MESHNODE" ] || {
						[ -e "/www/SIMPLE_MESH" ] && rm "/www/SIMPLE_MESH"	# accident
						touch "/www/SIMPLE_MESHNODE"
						rm "/www/GOOD_MODULE_UNLOAD"
						reboot
					}
				}
			;;
		esac
	;;
esac

[ -e "/etc/init.d/firewall" ] && {
	/etc/init.d/firewall disable
}

[ -e "/etc/init.d/ulogd" ] && {
	/etc/init.d/ulogd disable
}

[ "$( uci get dhcp.@dnsmasq[0].notinterface )" = "wan" ] || {
	_net local_inet_offer >/dev/null && {
		uci set dhcp.@dnsmasq[0].notinterface=wan
		/etc/init.d/dnsmasq restart
	}
}

if iptables -t mangle -nL shaper | grep -q ^ACCEPT ; then
	[ -e "/etc/init.d/netfilter" ] && {
		/etc/init.d/netfilter enable
		reboot
	}
else
	[ -s "/etc/rc.d/S45netfilter" ] || {
		/etc/init.d/netfilter enable
		/etc/init.d/netfilter restart
	}
fi

[ -e "/tmp/ENDBOOT" ] || {
	[ "$( _system uptime min )" -gt 5 ] && {
		touch "/tmp/ENDBOOT"
		killall rcS     # fixme!

		[ $( _system ram_size ) -lt 16384 ] && {
			[ -e "/www/GOOD_MODULE_UNLOAD" ] && {
				grep -q "ipt_LOG" "/www/GOOD_MODULE_UNLOAD" || {
					rm "/www/GOOD_MODULE_UNLOAD"
				}
			}

			/etc/init.d/S70prepare_fff+ unload_unneeded_kmodules
		}
	}
}
