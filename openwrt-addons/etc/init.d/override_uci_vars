#!/bin/sh /etc/rc.common
. /tmp/loader

START=01

# this file is a workaround for changing (uci-)settings for already running nodes
# later we will split it into separate mysettings.ipk for each installation
# if in doubt, remove this file from your own build

force_dnsserver()
{
	local ip_wish="$1"	# TODO: support for list
	local server

	[ -n "$( _wifi get any mode ap )" ] && {
		for server in $( uci get 'dhcp.@dnsmasq[0].server' ); do {
			[ "$server" = "$ip_wish" ] || {
				uci del_list "dhcp.@dnsmasq[0].server=$server"
			}
		} done

		[ "$( uci get 'dhcp.@dnsmasq[0].server' )" = "$ip_wish" ] || {
			uci add_list "dhcp.@dnsmasq[0].server=$ip_wish"
		}
	}
}

uci_already_added()
{
	local config="$1"	# e.g. network
	local section="$2"	# e.g. alias
	local item="$3"		# e.g. ipaddr
	local wish="$4"		# e.g. 10.10.43.33
	local value i=0

	while value="$( uci -q get $config.@$section[$i].$item )"; do {
		[ "$wish" = "$value" ] && return 0 || i=$(( i + 1 ))
	} done

	return 1
}

apply_olsr_roaming()
{
	local wired_networks="$1"
	local list_ap="$( _wifi get any mode ap ) $wired_networks"
	local index network list

	if [ -z "$list_ap" ]; then
		return 1
	else
		case "$CONFIG_PROFILE" in
			'liszt28'*)
				_wifi set adhoc any hidden 1
#				_wifi set adhoc any ssid ''	# -> does not work
			;;
		esac
	fi

	# e.g. dnsmasq 2.66 or openwrt script are broken for DHCP-range
	[ $OPENWRT_REV -ge 41037 ] || return 1
	[ -e "/lib/modules/$( uname -r )/macvlan.ko" ] || return 1
	kmodule_force_activation 'macvlan'

	uci set network.mastergate='interface'			# here we collect all interfaces, see below
	uci set network.mastergate.type='bridge'		# bridge needed for multiple interfaces
	uci set network.mastergate.proto='static'		# list of ifnames is added below
	uci set network.mastergate.ipaddr="$ROAMING_GATEWAY"
	uci set network.mastergate.netmask="$( _net cidr2mask "$ROAMING_PRE" )"

	# we occupy the existing 'wlan'-section (generated from apply_profile)
	uci set dhcp.wlan.interface='mastergate'

	# maybe also fill: 1, 3, 6, 12, 28 = ???
	uci del      dhcp.wlan.dhcp_option
	uci add_list dhcp.wlan.dhcp_option="3,$ROAMING_GATEWAY"	# same like 'option:router' is "option name => RFC 2132"
	uci add_list dhcp.wlan.dhcp_option="6,$ROAMING_DNS"

	uci set dhcp.wlan.leasetime='12h'	# very long: otherwise a ssh-session is lost when the IP changes...
	uci set dhcp.wlan.start="$ROAMING_DHCPSTART_LOCAL"
	uci set dhcp.wlan.limit='253'
	uci delete dhcp.wlan.netmask		# otherwise 'wlan.start' has no effect

	# FIXME! 2nd AP on same band does not work
	for index in $list_ap; do {
		if network="$( uci -q get wireless.@wifi-iface[$index].network )"; then
			# e.g. 'wlanRADIO1' 'wlan'
			uci set wireless.@wifi-iface[$index].disabled='0'		# force active
			uci set wireless.@wifi-iface[$index].disassoc_low_ack='1'

			# omit dnsmasq-logerrors:
			# in roaming mode we should only answer on 'mastergate' not e.g. 'wlan'
			case " $( uci -q get dhcp.@dnsmasq[0].notinterface ) " in
				*" $network "*)
					# only add once
				;;
				*)
					uci add_list dhcp.@dnsmasq[0].notinterface="$network"
				;;
			esac
		else
			# e.g. 'lan'
			network="$index"
			uci delete dhcp.$index
		fi

		uci set network.roaming${index}='device'
		uci set network.roaming${index}.type='macvlan'
		uci set network.roaming${index}.name="roaming${index}"
		uci set network.roaming${index}.ifname="@$network"
		uci set network.roaming${index}.macaddr='02:ff:ff:ff:00:00'		# same on all bands

		list="$( uci -q get network.mastergate.ifname )"
		case "$list" in
			*"roaming${index}"*)
			;;
			*)
				uci set network.mastergate.ifname="${list}${list:+ }roaming${index}"
			;;
		esac
	} done

	uci_already_added olsrd Hna4 netaddr "$ROAMING_NET_LOCAL" || {
		uci add olsrd Hna4 >/dev/null
		uci set olsrd.@Hna4[-1].netaddr="$ROAMING_NET_LOCAL"
		uci set olsrd.@Hna4[-1].netmask="$( _net cidr2mask "$ROAMING_PRE_LOCAL" )"
	}

	config_add_alias 'mastergate' "$ROAMING_ADR_LOCAL/$ROAMING_PRE_LOCAL"

	case "$HARDWARE" in
		'Mercury MAC1200R')
			# TODO: read valid interface combinations during ifup: (iw phy phy1 info)
			# dirty hack: ath10k cannot do hybrid (ibss/ap mixed) mode:
			_wifi set ap 5ghz disabled '1'
		;;
	esac

	_wifi set any any beacon_int '250'	# better powersafe and not too slow

	return 0
}

apply_olsr_speed()
{
	local value="$1"
	local i

	# setting interface-mode (ether/mesh) is only valid with 'etx_ffeth'
	# otherwise the daemon fails to start
	[ "$( uci -q get 'olsrd.@olsrd[0].LinkQualityAlgorithm' )" != 'etx_ffeth' ] && {
		i=0
		while uci -q get "olsrd.@Interface[$i]" >/dev/null; do {
			uci delete "olsrd.@Interface[$i].Mode" 2>/dev/null
			i=$(( i + 1 ))
		} done
	}

	# search for the string, which was added with this value
	# https://github.com/openwrt-routing/packages/commit/34e1ff5702372099599f764d272069ba914661c4
	grep -sq 'sven-ola' '/etc/init.d/olsrd' '/lib/functions/olsrd.sh' && {
		i=0
		while uci -q get "olsrd.@Interface[$i]" >/dev/null; do {
			uci set olsrd.@Interface[$i].speed="$value"
			i=$(( i + 1 ))
		} done
	}
}

apply_olsr_watchdog()
{
	local idx

	for idx in 0 1 2 3 4 5 6 7 8; do {
		case "$( uci -q get olsrd.@LoadPlugin\[$idx\].library )" in
			*'nameservice.so'*)
				# see S51cron/patch_udhcpc_script()
				uci set olsrd.@LoadPlugin\[$idx\].name_change_script='/etc/udhcpc.user'
				return 0
			;;
		esac
	} done
}

config_add_alias()
{
	local network="$1"
	local ip_and_mask="$2"
	local gateway="$3"
	local ip mask

	ip="${ip_and_mask%/*}"
	mask="${ip_and_mask#*/}"
	mask="$( _net cidr2mask "$mask" )"
# BLA
	uci_already_added network alias ipaddr "$ip" || {
		uci add network alias >/dev/null
		uci set network.@alias[-1].interface="$network"
		uci set network.@alias[-1].proto='static'
		uci set network.@alias[-1].ipaddr="$ip"
		uci set network.@alias[-1].netmask="$mask"
		[ -n "$gateway" ] && uci set network.@alias[-1].gateway="$gateway"
	}
}

hostapd_activate_coredump()
{
	# not needed for >= r39139 (why?)
	[ -e '/lib/wifi/hostapd.sh' ] && {
		grep -q "unlimited" "/lib/wifi/hostapd.sh" || {
			sed -i 's/hostapd -P/ulimit -c unlimited; &/' '/lib/wifi/hostapd.sh'
		}
	}

	# since r38988
	[ -e '/lib/netifd/wireless/mac80211.sh' ] && {
		grep -q 'unlimited' '/lib/netifd/wireless/mac80211.sh' || {
			sed -i 's|/usr/sbin/hostapd -P|ulimit -c unlimited; &|g' '/lib/netifd/wireless/mac80211.sh'
		}
	}
}

kmodule_is_deactivated()
{
	local kmodule="$1"
	local file

	# e.g. 'sch_teql' in /etc/modules.d/73-sched
	for file in /etc/modules.d/*; do {
		grep -q ^"# $kmodule" "$file" && return 0
		grep -q  ^"#$kmodule" "$file" && return 0
	} done

	return 1
}

kmodule_force_activation()
{
	local kmodule="$1"
	local file

	# e.g. 'sch_teql' in /etc/modules.d/73-sched
	for file in /etc/modules.d/*; do {
		grep -q ^"# $kmodule" "$file" && {
			sed -i 's/^[^a-z]*//' "$file"
			return 0
		}

		grep -q ^"#$kmodule" "$file" && {
			sed -i 's/^[^a-z]*//' "$file"
			return 0
		}
	} done
}

kmodule_force_deactivation()
{
	local kmodule="$1"
	local file

	# e.g. 'sch_teql' in /etc/modules.d/73-sched
	for file in /etc/modules.d/*; do {
		grep -q ^"$kmodule" "$file" && {
			sed -i "s/^$kmodule/# &/" "$file"
			return 0
		}
	} done
}

kmodules_group_deactivate()
{
	local group="$1"	# e.g. 'ipt-*'
	local file

	for file in /etc/modules.d/$group ; do {
		file="$( basename "$file" )"
		kmodule_is_deactivated "$file" || kmodule_force_deactivation "$file"
	} done
}

kmodules_group_activate()
{
	local group="$1"	# e.g. 'ipt-*'
	local file

	for file in /etc/modules.d/$group ; do {
		file="$( basename "$file" )"
		kmodule_is_deactivated "$file" && kmodule_force_activation "$file"
	} done
}

boot()
{
	local list pattern daemon i j good_hash

	for daemon in ulogd firewall sysntpd; do {
		[ -e "/etc/init.d/$daemon" ] || continue
		/etc/init.d/$daemon enabled && /etc/init.d/$daemon disable
	} done

	# work around a hanging network during shutdown
	grep -sq ^'STOP=' '/etc/init.d/network' && {
		sed -i 's/^STOP=/# &/' '/etc/init.d/network'
	}

	# work around safed conffile during sysupgrade
	fgrep -q '/etc/profile.d' '/rom/etc/profile' && {
		fgrep -q '/etc/profile.d' '/etc/profile' || {
			cp '/rom/etc/profile' '/etc/profile'
		}
	}

	# FIXME! only for transition/renaming 'translate -> i18n' and 'wget -> curl'
	[ -e '/etc/kalua/translate' ] && rm '/etc/kalua/translate'
	[ -e '/etc/kalua/wget' ] && rm '/etc/kalua/wget'

	# if for some reason 'loopback' is missing (this adds an unnamed section)
	# TODO: we also need to check for 'network.@loopback[0].ifname'
	uci get network.loopback.ifname >/dev/null || {
		uci add network 'loopback' >/dev/null
		uci set network.@loopback[-1].interface='loopback'
		uci set network.@loopback[-1].ifname='lo'
		uci set network.@loopback[-1].proto='static'
		uci set network.@loopback[-1].ipaddr='127.0.0.1'
		uci set network.@loopback[-1].netmask='255.0.0.0'
	}

	# if for some reason 'lan' is missing
	# TODO: we also need to check for 'network.@lan[0].ifname'
	uci get network.lan.ifname >/dev/null || {
		uci add network 'lan' >/dev/null
		uci set network.@lan[-1].interface='lan'
		uci set network.@lan[-1].ifname='eth0'
		uci set network.@lan[-1].proto='static'
		uci set network.@lan[-1].ipaddr="$(  _ipsystem getvar 'LANADR' )"
		uci set network.@lan[-1].netmask="$( _ipsystem getvar 'LANMSK' )"
	}

	if [ -e '/etc/init.d/apply_profile' ]; then
		[ -s '/www/cgi-bin-welcome.sh'	] || ln -s '/www/cgi-bin-welcome'   '/www/cgi-bin-welcome.sh'
		[ -s '/www/cgi-bin-sql.sh'	] || ln -s '/www/cgi-bin-sql'	    '/www/cgi-bin-sql.sh'
		[ -s '/www/cgi-bin-tool.sh'	] || ln -s '/www/cgi-bin-tool_fff+' '/www/cgi-bin-tool.sh'

		uci set uhttpd.main.interpreter='.sh=/bin/ash'

		# https://dev.openwrt.org/changeset/46688/trunk
		uci set uhttpd.px5g.country='DE'
		uci set uhttpd.px5g.state='Thuringia'
		uci set uhttpd.px5g.location='Weimar'

		[ -n "$LOWMEM" ] && {
			kmodules_group_deactivate '*'
			kmodules_group_activate   'zram'
			kmodules_group_activate   'lib-lzo'
			kmodules_group_activate   'b44'

#			kmodules_group_deactivate  'ipt-*'
#			kmodule_force_deactivation 'b43'
#			kmodule_force_deactivation 'mac80211'
#			kmodule_force_deactivation 'cfg80211'	# includes compat
#			kmodule_force_deactivation 'ipv6'
#			kmodule_force_deactivation 'ip6tables'

			/etc/init.d/odhcpd disable
		}

		return 0
	else
		# https://lists.openwrt.org/pipermail/openwrt-devel/2015-January/030887.html
		rm /etc/uci-defaults/* 2>/dev/null

		[ -n "$LOWMEM" -a ! -e '/www/kmods_fixed' ] && {
			touch '/www/kmods_fixed'

			kmodules_group_deactivate '*'		# unneeded, but doesnt hurt (for old nodes)
			kmodules_group_activate   'zram'
			kmodules_group_activate   'lib-lzo'
			kmodules_group_activate   'b44'

			# gpio_button_hotplug leds_gpio - needed?

			kmodule_force_activation 'b43'
			kmodule_force_activation 'mac80211'
			kmodule_force_activation 'cfg80211'	# includes compat
			kmodule_force_activation 'ath'
			kmodule_force_activation 'ath5k'
			# allow 'switch', 'diag'

			needs_full_kmodules()
			{
				_net local_inet_offer >/dev/null && return 0
				test -e '/www/SIMPLE_MESHNODE' && return 1

				return 0
			}

			# for F in /etc/modules.d/*; do echo "# $F"; cat $F; done
			needs_full_kmodules && {
				kmodule_force_activation 'ipt-core'
						# has:  x_tables xt_tcpudp ip_tables iptable_filter iptable_mangle xt_limit
						#       xt_mac xt_multiport xt_comment ipt_LOG xt_TCPMSS ipt_REJECT
						# need: x_tables xt_tcpudp ip_tables iptable_filter iptable_mangle   ---
						#       xt_mac    ---          ---      ---    xt_TCPMSS ipt_REJECT

				kmodule_force_activation 'ipt-conntrack'
						# has:  nf_conntrack nf_defrag_ipv4 nf_conntrack_ipv4 xt_state
						#       iptable_raw xt_NOTRACK xt_CT xt_conntrack
						# need: nf_conntrack nf_defrag_ipv4 nf_conntrack_ipv4   ---
						#           ---        ---      ---     ---

				kmodule_force_activation 'ipt-nat'
						# has:  nf_nat iptable_nat ipt_MASQUERADE
						# need: nf_nat iptable_nat     ---

				# TODO:
				# at least here, it needs a function which enables
				# a specific kernel-module, no matter in which file
				kmodule_force_activation 'ipt-ipopt'
						# has:  xt_mark + sehr viele
						# need: xt_mark
			}
		}
	fi

	integer2fourhex()	# e.g. 8 -> 00:08
	{			# fixme! max = 999 fixme! generalize it, join with bssid_wellformed()
		if [ $1 -lt 100 ]; then
			if [ $1 -lt 10 ]; then
				echo "00:0$1"
			else
				echo "00:$1"
			fi
		else
			echo "0$( echo "$1" | cut -b 1 ):$( echo "$1" | cut -b 2-3 )"
		fi
	}

	apply_olsr_speed '6'

	kmodule_force_deactivation sch_teql
	kmodule_force_deactivation ifb

	case "$HARDWARE" in
		'Mercury MAC1200R')
			# dirty hack: ath10k cannot do hybrid (ibss/ap mixed) mode:
			_wifi set ap 5ghz disabled '1'
		;;
		'La Fonera 2.0N')
			# TODO: query possible interface combinations
			# disable adhoc for now
			# https://lists.openwrt.org/pipermail/openwrt-devel/2013-June/020559.html
			_wifi set adhoc any disabled '1'
			_wifi set ap    any disabled '0'
		;;
	esac

	case "$HARDWARE" in
		'TP-LINK TL-WDR4900'*|'TP-LINK TL-WR703N v1')
			# we use the button to trigger an WPS-action/soundplayer
			[ -e '/etc/rc.button/reset' ] && rm '/etc/rc.button/reset'
		;;
	esac

	case "$HARDWARE" in
		'TP-LINK TL-WDR4900'*)
			# dirty-fix default mac: 00:04:9f:ef:01:01
			# https://dev.openwrt.org/ticket/14714

			[ -e '/www/monitoring.wifimac' ] && {
				# wifimac is correct
				read -r wmac <'/www/monitoring.wifimac'
				wmac="${wmac:0:2}:${wmac:2:2}:${wmac:4:2}:00:$( integer2fourhex "$NODENUMBER" )"

				[ -z "$( uci -q get network.lan.macaddr )" ] && uci set network.lan.macaddr="$wmac"
				[ -z "$( uci -q get network.wan.macaddr )" ] && uci set network.wan.macaddr="$wmac"
			}
		;;
	esac

	# workaround:
	grep -q 'Wartungsmodus' '/etc/config/wireless' && {
		sed -i "s/option ssid.*/option ssid '$( _weblogin metadata_locationname )'/g" '/etc/config/wireless'
	}

	uci set network.innercityVPN.mtu='1280'		# see vpn()

	uci set sms.@sms[0].username='gforce'
	uci set sms.@sms[0].password='mvemjsunpsms77'

	[ -e '/www/cgi-bin-status.html' ] || {
		_http redirect '302' 'cgi-bin-status.sh' 'html_only' >'/www/cgi-bin-status.html'
	}

	# disable OLSRd1 - IPv6
	[ -e '/etc/config/olsrd6' ] && uci set olsrd6.@olsrd[0].disabled='1'

	# mark end of startup-sequence
	grep -q "ENDBOOT" '/etc/init.d/done' || sed -i 's|^}|\n	touch /tmp/ENDBOOT\n}|' '/etc/init.d/done'

	pattern='procd_open_instance'
	file='/etc/init.d/dnsmasq'
	grep -q "$pattern"$ "$file" && {
		sed -i "s/${pattern}$/&; procd_set_param limits core='unlimited'/" "$file"
	}

	# fix sysupgrade, see patch in r39169:
	[ $OPENWRT_REV -eq 39139 ] && {
		grep -q ' mount ' '/etc/init.d/boot' && {
			sed -i 's| mount | /bin/mount |' '/etc/init.d/boot'
			sed -i 's|umount |/bin/umount |' '/etc/init.d/umount'
			sed -i 's|mount |/bin/mount |' '/lib/functions.sh'
			sed -i 's|umount -l |/bin/umount -l |' '/lib/upgrade/common.sh'
			sed -i 's|mount -o |/bin/mount -o |' '/lib/upgrade/common.sh'
			sed -i 's#mount | #/bin/mount | #' '/lib/upgrade/common.sh'
		}
	}

	# https://dev.openwrt.org/ticket/14705
	[ $OPENWRT_REV -le 39218 ] && {
		file='/lib/netifd/wireless/mac80211.sh'
		pattern='json_get_vars bssid ssid basic_rate key'
		grep -sq "$pattern"$ "$file" && {
			sed -i "s/$pattern/$pattern mcast_rate/" "$file"
		}
	}

	# no DNS-responses on WAN from outside
	[ "$( uci -q get dhcp.@dnsmasq[0].notinterface )" = 'wan' ] || {
		_net local_inet_offer >/dev/null && {
			uci set dhcp.@dnsmasq[0].notinterface='wan'	# add pppoe-wan?
		}
	}

	[ $OPENWRT_REV -eq 38043 ] && {
		grep -q 'sleep 30' '/etc/init.d/olsrd' || {
			sed -i 's/^start() {$/&\nsleep 30/' '/etc/init.d/olsrd'
		}
	}

	# TODO: be more exact - set for correct radioX
	[ -e "/lib/modules/$( uname -r )/ath9k.ko" ] && {
		# enforce 802.11n
		# https://dev.openwrt.org/ticket/17748
		# https://dev.openwrt.org/ticket/17541
		_wifi set any any htmode HT20
	}

	# AP = autochannel
	case "$CONFIG_PROFILE" in
		*_ap)
			# our special country 'Micronesia' = FM with valid channel 1-11 and 36-48
			if grep -s 'REGHACK:' '/etc/openwrt_patches' | grep -q ' FM '; then
				_wifi set ap 2ghz channel 'auto'
				_wifi set ap 5ghz channel 'auto'
			else
				# typically the mesh is on channel 11
				_wifi set ap 2ghz channel "$( _math random_integer 1 11 )"

				# TODO: use only non_dfs_channels
				# iw phy1 info | grep '* .... MHz ' | cut -d'[' -f2 | cut -d']' -f1 | grep -v 'DFS'
				_wifi set ap 5ghz channel \
					"$( _list random_element '36 40 44 48 52 56 60 64 100 104 108 112 116 120 124 128 132 136 140 149 153 157 161 165' )"
			fi

			case "$( uci -q get wireless.radio0.htmode )" in
				'HT40'*)
					uci set wireless.radio0.htmode='HT20'
				;;
			esac
		;;
	esac

	needs_ipv6_disable()
	{
		case "$CONFIG_PROFILE" in
			boltenhagendh*|schoeneck*)
				return 0
			;;
		esac

		test -n "$LOWMEM"
	}

	needs_ipv6_disable && {
		/etc/init.d/6relayd enabled && /etc/init.d/6relayd disable	# removed in r40893
		/etc/init.d/odhcpd  enabled && /etc/init.d/odhcpd  disable

		uci show network.wan6 >/dev/null && {
			uci set network.wan6.disabled='1'
			uci set network.wan6.ifname=
		}
	}

	needs_serial_console_disable()
	{
		case "$CONFIG_PROFILE" in
			boltenhagendh*|schoeneck*)
				return 0
			;;
		esac

		test -n "$LOWMEM"
	}

	needs_serial_console_disable && {
		grep "::askconsole:" "/etc/inittab" | grep -q ^"#" || sed -i 's/^.*::askconsole:.*/# &/' "/etc/inittab"
		grep "::askfirst:"   "/etc/inittab" | grep -q ^"#" || sed -i 's/^.*::askfirst:.*/# &/'   "/etc/inittab"
	}

	# mail: send via scp OR 0ldskool
	case "$CONFIG_PROFILE" in
		liszt28*)
			uci set mail.@smtp[0].mail='logins@bluebottle.com'
			uci set mail.@smtp[0].auth='bastian@10.63.2.34:kalua_mail'
		;;
		ffweimar*)
			# needs setup / concept
		;;
		*)
			uci set mail.@smtp[0].mail='logins@bluebottle.com'
			uci set mail.@smtp[0].auth='-P 222 bastian@bwireless.mooo.com:kalua_mail'
		;;
	esac

	case "$CONFIG_PROFILE" in
		malchow*|ilm1*|tkolleg*|fparkssee*|marinapark*|aschbach*)
			uci set system.@monitoring[0].report_daily_stats='true'
		;;
		liszt28*|rehungen*|boltenhagen*|castelfalfi*|berlinle*|giancarlo*)
			uci set system.@monitoring[0].report_daily_stats='true'
		;;
	esac

	uci set system.@monitoring[0].serverip='84.38.67.43'

	if [ -n "$LOWMEM" ]; then
		uci delete 'dhcp.@dnsmasq[0].dhcpscript' 2>/dev/null

		case "$CONFIG_PROFILE" in
			*_ap)
				# activate on all lowmem-devices when unset
				[ -z "$( uci get olsrd.@meta[0].hnaslave )" ] && {
					_net local_inet_offer >/dev/null || uci set olsrd.@meta[0].hnaslave=1
				}
			;;
			*_adhoc)
				[ -e "/www/SIMPLE_MESHNODE" ] || {
					# unforce stricter kmodule unloading
					touch "/www/SIMPLE_MESHNODE"
					rm "/www/GOOD_MODULE_UNLOAD"
				}
			;;
		esac

		uci set uhttpd.main.redirect_https='0'
		uci set uhttpd.main.interpreter='.sh=/bin/ash'
		uci set dhcp.@dnsmasq[0].cachesize=100
	else
		uci set dhcp.@dnsmasq[0].cachesize=1000
		uci set uhttpd.main.redirect_https='0'

		if [ $( _system ram_size ) -gt 32768 ]; then
			uci set uhttpd.main.max_requests=10
		else
			uci set uhttpd.main.max_requests=3
		fi

		uci set uhttpd.main.interpreter='.sh=/bin/ash'

		# https://dev.openwrt.org/changeset/22589
		uci set uhttpd.main.rfc1918_filter='0'
		uci set uhttpd.main.listen_http='80'
		if [ -e "/usr/lib/uhttpd_tls.so" -o -e "/usr/lib/opkg/info/uhttpd-mod-tls.list" ]; then
			uci set uhttpd.main.listen_https='443'
		else
			uci delete uhttpd.main.listen_https
		fi
	fi

	remove_section()
	{
		local check_var="$1"	# e.g. network.@alias[].interface
		local check_value="$2"	# e.g. loopback
		local p1="$( echo "$check_var" | cut -d'[' -f1 )"
		local p2="$( echo "$check_var" | cut -d']' -f2 )"

		local i
		for i in $( seq 15 -1 0 ); do {
			while [ "$( uci -q get "${p1}[$i]${p2}" )" = "$check_value" ]; do {
				uci delete "${p1}[$i]"
			} done
		} done
	}

	apply_cronwatchdog()	# cron-watchdog via netifd-dhcp-hotplug-call: iface/60-dyndns
	{
		remove_section "network.@alias[].interface" 'loopback'
		uci add network 'alias' >/dev/null
		uci set network.@alias[-1].interface='loopback'
		uci set network.@alias[-1].proto='dhcp'
		uci set network.@alias[-1].defaultroute='0'	# dont apply default route
		uci set network.@alias[-1].peerdns='0'		# and DNS

		remove_section "dhcp.@host[].name" 'lo-alias'
		uci add dhcp 'host' >/dev/null
		uci set dhcp.@host[-1].ip='127.0.0.2'
		uci set dhcp.@host[-1].mac='00:00:00:00:00:00'
		uci set dhcp.@host[-1].name='lo-alias'

		remove_section "dhcp.@dhcp[].interface" 'loopback'
		uci add dhcp 'dhcp' >/dev/null
		uci set dhcp.@dhcp[-1].interface='loopback'
		uci set dhcp.@dhcp[-1].start='2'
		uci set dhcp.@dhcp[-1].limit='2'
		uci set dhcp.@dhcp[-1].leasetime='1h'
		uci set dhcp.@dhcp[-1].force='1'
		uci set dhcp.@dhcp[-1].ignore='0'
	}

	[ -z "$LOWMEM" ] && apply_cronwatchdog

	case "$CONFIG_PROFILE" in
		apphalle*)
			list="0174/3564025"
		;;
		schoeneck*)
			list="01729094456"
		;;
		aschbach*|hotello*)
			list="01728117657 01727772555 01775906689"
		;;
		liszt28*)
			list=
		;;
		spbansin*|itzehoe*)
			list="01601531855"
		;;
		tkolleg*)
			list="01714338506"
		;;
		satama*)
			# list="016096378028"
		;;
		ejbw*)
			list="01622666169"	# lars
		;;
		rehungen*)
			list=
		;;
		malchow*)
			list='01736234581'
		;;
	esac
	uci set sms.@sms[0].admin="0176/24223419 $list"

	# see /usr/sbin/cron.reverse_ssh_tunnel
	case "$CONFIG_PROFILE" in
		extrawatt*|shankar*|fparkssee*|limona*|marinapark*|versiliaje*|cupandcoffee*|wuensch*|giancarlo*|tkolleg*)
			uci set system.@monitoring[0].maintenance='reverse_sshtunnel'
		;;
		marinabh*|amalienhof*|adagio*|palais*|paltstadt*|cospudener*)
			uci set system.@monitoring[0].maintenance='reverse_sshtunnel'
			uci set system.@monitoring[0].maintenance_ports='22 80'
		;;
	esac

	local up down unshaped mac
	case "$CONFIG_PROFILE" in
		apphalle*)
			up=384kbit
			down=3mbit
		;;
		rehungen*)
			case "$NODENUMBER" in
				36)
					# haupt52 (was: 16mbit)
					up=64kbit
					down=64kbit
				;;
				37|76|77|92|95)
					up=768kbit	# haupt25|schuetz17
					down=16mbit
				;;
				106|107|30|108|110|43|44|66|67|97|20|21)
					# breite6|ONEklausg70|schuetz2|101b|haupt15|ONEhaupt43a|haupt70
					up=768kbit
					down=10mbit
				;;
				*)
					up=768kbit
					down=6mbit
				;;
			esac
		;;
		limona*)
			up=768kbit
			down=8mbit
		;;
		leonardo*|castelfalfi*|adagio*)
			up=768kbit
			down=6mbit
		;;
		hotello*)
			up=512kbit
			down=4mbit
		;;
		liszt28*)
			# R30mb|T61|f36NAS|schlachtNAS|danny|ApplePhotograf|ralfRadio
			unshaped='70:1a:04:b1:5f:cf 00:13:e8:82:7e:4b 02:50:43:ab:1c:91 02:50:43:34:25:bc 9c:b7:0d:a2:49:a5 5c:96:9d:7a:9f:8d 00:90:3e:fc:81:c2'
			up=384kbit
			down=1500kbit
		;;
		ffweimar*)
		;;
		*)
			up=128kbit
			down=1mbit
		;;
	esac

	[ -n "$up" -a -n "$down" ] && {
		uci set system.@weblogin[0].default_speed_up="$up"
		uci set system.@weblogin[0].default_speed_down="$down"
	}

	uci -q get system.@weblogin[0].mac_unshaped >/dev/null && uci delete 'system.@weblogin[0].mac_unshaped'
	for mac in $unshaped; do {
		uci -q get "system.@weblogin[0].mac_unshaped" | grep -q "$mac" || {
			uci add_list system.@weblogin[0].mac_unshaped="$mac"
		}
	} done


	case "$CONFIG_PROFILE" in
		fparkssee*)
			uci set system.@weblogin[0].gateway_check='10.63.222.33'
		;;
		satama*)
			uci set system.@weblogin[0].gateway_check='10.63.119.33'
		;;
		marinapark*)
			uci set system.@weblogin[0].gateway_check='10.63.10.33'
			uci set system.@monitoring[0].maintenance_force='true'		# FIXME!
		;;
	esac

	for INDEX in $( _wifi get any mode ap ); do {
		uci set wireless.@wifi-iface[$INDEX].disassoc_low_ack='0'
	} done

	# let wifi-dhcp be on 2ghz - till we fix it
	# e.g. TPLINK 4900 has 2ghz on 2nd wifi-phy
	for INDEX in $( _wifi get any mode ap ); do {
		_wifi is2ghz $INDEX && {
			NAME="$( uci -q get wireless.@wifi-iface[$INDEX].network )"
			uci set dhcp.wlan.interface="$NAME"
			break
		}
	} done

	_wifi set ap 5ghz disabled '1'
	uci set system.@weblogin[0].redirect_dns='true'

	# disable wan6-dhcp if wan4-proto = static
	[ "$( uci -q get network.wan.proto )" = 'static' ] && {
		uci set network.wan6.disabled='1'
	}

	case "$CONFIG_PROFILE" in
		monami*)
			uci set system.@weblogin[0].db_localcopy='true'
			uci set system.@weblogin[0].authserver="$( _ipsystem getvar 'LANADR' '9' )"

			case "$NODENUMBER" in
				10|12)
					_wifi set adhoc 2ghz mcast_rate '1000'
				;;
			esac
		;;
		limona*)
			# node6 = SSID-2 = 4,3 + (5)		# alles anders seit: 2015oct20
			# node5 = SSID-5 = nix
			# node4 = SSID=3 = 3,6 (wifi-only)
			# node3 = SSID-4 = 4,6
			# node2 = SSID-1 = nix

			uci set system.@monitoring[0].lazy_wifi_framecounter='false'
			uci set system.@weblogin[0].respect_missing_db='true'

			_wifi set adhoc 2ghz ssid 'intern.2GHz'
			_wifi set adhoc 5ghz ssid 'intern.5GHz'

			apply_olsr_roaming "$ROAMING" && {
				_wifi set ap any ssid 'Appartementhaus Limona'
			}
		;;
		aschbach*)
			apply_olsr_roaming "$ROAMING" && {
				_wifi set ap any ssid 'Aschbacher Hof'
			}
		;;
		cospudener*)
			_wifi set ap any ssid 'Zwischen.Himmel.und.Erde'
			touch /tmp/FREE
		;;
		extrawatt*)
			uci set system.@weblogin[0].freelan='1'
		;;
		berlinle*)
			uci set olsrd.@meta[0].hnaslave=0
		;;
		olympia*)
			[ "$NODENUMBER" = '7' ] && uci set system.@monitoring[0].pingcheck="$( _ipsystem getvar WIFIADR 2 )"
			uci set system.@monitoring[0].report_switch_change='true'
			_wifi set ap any ssid "Hotel Olympia $(( NODENUMBER - 1 ))"
		;;
		castelfalfi*)
			[ $( _system date unixtime ) -lt $( _system date 2unixtime 'Sun Apr 10 23:55:00 CET 2015' ) ] && {
				touch '/tmp/FREE'
			}

			uci set system.@weblogin[0].defaultlang='en'
			uci set system.@weblogin[0].auth_type='roomnumber'
			uci set system.@weblogin[0].ticketstock='32'
			uci set system.@weblogin[0].force_lan_reachable='1'
			uci set system.@weblogin[0].always_reachable='true'

			uci set olsrd.@meta[0].ignore_restarts='true'
		;;
		fparkssee*|satama*|marinapark*)
			if [ -z "$LOWMEM" ]; then
				uci set olsrd.@meta[0].hnaslave=0
			else
				uci set system.@weblogin[0].enabled='0'
			fi

			_wifi set adhoc any mcast_rate '1000'
			_wifi set adhoc 2ghz channel '11'
			_wifi set adhoc 2ghz bssid '02:ca:ff:ee:00:11'

			uci set olsrd.@olsrd[0].LinkQualityAlgorithm='etx_ffeth'
		;;
		apphalle*)
			uci set olsrd.@meta[0].hnaslave='0'

			_wifi set ap    any  ssid "$( _weblogin metadata_locationname | cut -d' ' -f1 ) $NODENUMBER"

			_wifi set adhoc 2ghz ssid 'intern.2GHz'
			_wifi set adhoc 2ghz mcast_rate '6000'

			_wifi set adhoc 5ghz ssid 'intern.5GHz'
			_wifi set any   5ghz channel '104'
			_wifi set any   5ghz txpower '21'
			_wifi set ap    5ghz disabled '1'
			_wifi set any   5ghz chanbw '5'

			apply_olsr_roaming "$ROAMING" && {
				_wifi set ap any ssid 'Appartementhaus am Dom'
			}
		;;
		xoai*)
			uci set system.@weblogin[0].enabled='1'
			uci set system.@weblogin[0].dynamic_portfw='00:1a:97:'	# cam/ICS2030
			uci set system.@system[0].timezone='ICT-7'

			_wifi set adhoc 2ghz ssid 'intern.2GHz'
			_wifi set adhoc 5ghz ssid 'intern.5GHz'

			apply_olsr_roaming "$ROAMING" && {
				_wifi set ap any ssid 'hotelxoai.com'
			}
		;;
		tuberlin*)
			uci set system.@weblogin[0].enabled='0'
		;;
		amalienhof*)
			uci set system.@weblogin[0].enabled='0'
			uci set olsrd.@meta[0].hnaslave=0
			_wifi set ap 2ghz ssid 'Borbing'
		;;
		ffweimar*)
			uci set system.@monitoring[0].autoupload_config='true'
			uci set system.@weblogin[0].freelan='1'
			uci set system.@weblogin[0].auth_type='none'
			[ -z "$LOWMEM" ] && uci set system.@monitoring[0].statusprecache='1'
		;;
		ibfleesensee*)
			uci set system.@weblogin[0].enabled='1'
			uci set system.@weblogin[0].always_reachable='true'
			uci set olsrd.@meta[0].hnaslave=0

			uci set system.@monitoring[0].cdp_send='true'
			URL='http://downloads.openwrt.org/barrier_breaker/14.07/ar71xx/generic/packages/oldpackages/cdp-tools_20070302-1_ar71xx.ipk'
			echo >>$SCHEDULER "_software package_is_installed cdp-tools || _software packages_install $URL"

			_wifi set ap 2ghz ssid 'Iberotel'
			_wifi set ap 5ghz ssid 'Konferenz'

			[ "$NODENUMBER" = '2' ] && {
				config_add_alias 'lan' '192.168.112.2/24' '192.168.112.1'
				uci set system.@monitoring[0].cisco_collect='true'
				uci set system.@monitoring[0].ignore_load='true'

				uci set network.wan.shaping='true'
				uci set network.wan.shaping_uplink='7500'
				uci set network.wan.shaping_downlink='7500'

				uci set dhcp.lan.leasetime='40m'
			}
		;;
		palais*)
			uci set system.@monitoring[0].ignore_wifi_framecounter='true'
			uci set olsrd.@meta[0].allow_no_neigh='true'
			uci set olsrd.@olsrd[0].LinkQualityAlgorithm='etx_ffeth'

			# weimarnetz
			_wifi set adhoc 2ghz mcast_rate '1000'
			_wifi set adhoc 2ghz bssid '02:ca:ff:ee:ba:be'
			_wifi set any   2ghz channel 5
		;;
		paltstadt*)
			case "$NODENUMBER" in
				3)
					uci set system.@monitoring[0].maintenance='reverse_sshtunnel'
					uci set system.@monitoring[0].maintenance_ports='22 80'
					uci set system.@system[0].db_backup_force='true'
				;;
			esac

			uci set olsrd.@olsrd[0].LinkQualityAlgorithm='etx_ffeth'
			uci set olsrd.@meta[0].throttle_traffic='1'
			uci set system.@weblogin[0].authserver='10.10.3.1'

			# weimarnetz
			_wifi set adhoc 2ghz mcast_rate '1000'
			_wifi set adhoc 2ghz bssid '02:ca:ff:ee:ba:be'
			_wifi set any   2ghz channel 5
		;;
		abtpark*)
			uci set system.@weblogin[0].ticketstock='32'

			[ $OPENWRT_REV -eq 44420 ] && {
				uci del wireless.radio1.htmode		# FIXME!
				uci del wireless.radio0.htmode
			}

			_wifi set adhoc 2ghz ssid 'x'
			_wifi set ap    2ghz ssid 'a-park.de'

			_wifi set adhoc 5ghz ssid 'X'
			_wifi set ap    5ghz ssid 'a_park.de'
			_wifi set ap    5ghz disabled '1'
			_wifi set any   5ghz chanbw '5'
			_wifi set any   5ghz channel '104'
			_wifi set any   5ghz txpower '21'
		;;
		liszt28*)
			pos()
			{
				local lat="${1//,/.}"	# ',' -> '.'
				local lon="${2//,/.}"

				uci set system.@admin[0].latlon="$lat;$lon"
			}

			# http://www.bing.com/maps/?FORM=EXIPRV -> rightlick on location + copy&paste coords
			case "$NODENUMBER" in
				705) pos '50,990370' '11,331675' ;;	# F36-NAS
				276) pos '50,990377' '11,331733' ;;	# F36-keller-INET
				277) pos '50,990390' '11,331680' ;;	# F36-stube
				719) pos '50,990433' '11,331725' ;;	# F36-longshot-to-schlacht
				  4) pos '50,990426' '11,331749' ;;	# F36-linksys
				337) pos '50,990478' '11,331725' ;;	# F38-emilio
				275) pos '50,990412' '11,331637' ;;	# F36-ayse
				670) pos '50,989698' '11,336485' ;;	# schlacht: longshot-schlacht-to-f36
				261) pos '50,989848' '11,336757' ;;	# schlacht: fenstercam
				222) pos '50,989877' '11,336734' ;;	# schlacht: buerocam
				  2) pos '50,989873' '11,336828' ;;	# schlacht: buero
				799) pos '50,989937' '11,337003' ;;	# schlacht: elsternest
				814) pos '50,989957' '11,336924' ;;	# schlacht: nano-dach
				599) pos '50,989943' '11,336813' ;;	# schlacht: kueche
				666) pos '50,989927' '11,336541' ;;	# schlacht: klampfenkurt
				707) pos '50,989983' '11,336722' ;;	# schlacht: tommek
				350) pos '50,989927' '11,336710' ;;	# schlacht: wachturm/radio
				556) pos '50,990029' '11,336612' ;;	# schlacht: sommerbar/pico
				776) pos '50,990051' '11,336605' ;;	# schlacht: sommerbar/cpe210
				837) pos '50,990000' '11,336636' ;;	# schlacht: archer/keller
				262) pos '50,989370' '11,334436' ;;	# schlacht: muelltonne
				865) pos '50,989275' '11,334420' ;;	# schlacht: danny-neu
				667) pos '50,988944' '11,333984' ;;	# schlacht: joerg
				278) pos '50,989271' '11,332866' ;;	# meyer: alrik
				825) pos '50,998949' '11,339429' ;;	# BAMAG-dach-richtung-wagenplatz
				603) pos '50,998949' '11,339429' ;;	# ewerk-kesselsaal
				810) pos '50,979846' '11,328856' ;;	# markt5-DSL
				  6) pos '50,979861' '11,328919' ;;	# markt5-drucker
				279) pos '50,988058' '11,318686' ;;	# roehr30
				371) pos '50,979650' '11,324379' ;;	# DNT-WillhelmTell
				  *) pos '50,991342' '11,332552' ;;	# abstellgleis
			esac

			_wifi set any any chanbw '20'
			uci set system.@monitoring[0].nightly_longrange='true'
			uci set system.@monitoring[0].send_mapapi='true'
			uci set olsrd.@olsrd[0].LinkQualityAlgorithm='etx_ffeth'
			uci set system.@monitoring[0].ignore_lossyethernet='true'	# FIXME! (10.63.42.125)

			[ -n "$LOWMEM" -a $OPENWRT_REV -gt 43735 ] && {
#				uci set wireless.radio0.disabled='1'
				uci delete network.wan6
				uci set network.wan.proto='static'

				/etc/init.d/odhcpd disable
				/usr/sbin/uhttpd disable
				/etc/init.d/sysntpd disable
				/etc/init.d/dropbear disable
				/etc/init.d/dnsmasq disable
				/etc/init.d/log disable
				/etc/init.d/telnet enable

				grep 'askconsole' '/etc/inittab' | grep -q ^'#' || {
					sed -i 's/.*askconsole/# &/' /etc/inittab
				}
			}

			[ -x '/usr/sbin/olsrd2' ] && {
				# disable IPv6
				# http://www.olsr.org/mediawiki/index.php/OLSR_network_deployments#IPv4_or_IPv6_only_mesh_network_with_olsrd2
				for i in '-0.0.0.0/0' '-::1/128' 'default_accept'; do {
					case "$( uci -q get olsrd2.@olsrv2[0].originator )" in
						*"$i"*)
						;;
						*)
							uci add_list olsrd2.@olsrv2[0].originator="$i"
						;;
					esac
				} done

				for i in '-0.0.0.0/0' '-::1/128' 'default_accept'; do {
					# shellcheck disable=SC2034
					for j in 0 1 2 3; do {
						case "$( uci -q get olsrd2.@interface[$j].bindto )" in
							*"$i"*)
							;;
							*)
								uci add_list olsrd2.@interface[$j].bindto="$i"
							;;
						esac
					} done
				} done

				# allow/tweak wan
				uci set olsrd2.@interface[2].ignore='0'
				uci set olsrd2.@interface[2].rx_bitrate='1G'
				uci set olsrd2.@interface[2].tx_bitrate='1G'
				# allow/tweak lan
				uci set olsrd2.@interface[3].ignore='0'
				uci set olsrd2.@interface[3].rx_bitrate='1G'
				uci set olsrd2.@interface[3].tx_bitrate='1G'
			}

			# so we can call 'http://www.internet'
			uci set dhcp.@dnsmasq[0].local='/internet/'
			uci set dhcp.@dnsmasq[0].domain='internet'

			hostapd_activate_coredump

			uci set network.loopback.ip6assign='60'		# for OLSR2
			apply_olsr_speed '7'

			[ "$( uci -q show network.wan.proto )" = 'pppoe' ] && {
				uci set system.@system[0].avoid_autoreboot='true'
			}

			[ -n "$LOWMEM" ] && uci set system.@weblogin[0].enabled='0'
			[ -z "$LOWMEM" ] && uci set system.@monitoring[0].statusprecache='1'
			uci set system.@monitoring[0].ignore_switch_error='true'
			uci set system.@monitoring[0].autoupload_config='true'

			uci set system.@weblogin[0].respect_missing_db='true'
			uci set system.@weblogin[0].freelan='1'
			uci set system.@weblogin[0].logtraffic='1'
			uci set system.@weblogin[0].authserver="$( _ipsystem getvar 'LANADR' '276' )"

			uci set olsrd.@meta[0].fixedarp='1'
			uci set olsrd.@meta[0].throttle_traffic='1'
			uci set olsrd.@meta[0].nexthop_dns='false'	# FIXME!

			case "$HARDWARE" in
				'Seagate GoFlex Home')
					uci set system.@system[0].avoid_autoreboot='true'
				;;
			esac

			case "$NODENUMBER" in
				670)
					# AlexLaterne
					uci set system.@monitoring[0].pingcheck='10.63.209.129'		# F36
					uci set dhcp.lan.ignore=1
				;;
				99)
					# DEAD: laborAP
					uci set system.@monitoring[0].pingcheck='10.63.21.97'
					uci set system.@monitoring[0].pingcheck_lazy='1'
				;;
				603)
					# ewerkNEU
					uci set system.@monitoring[0].pingcheck='8.8.8.8'
					uci set system.@monitoring[0].pingcheck_lazy='1'
					touch /tmp/FREE
				;;
				280)
					# danny
					uci set system.@monitoring[0].pingcheck='8.8.8.8'
				;;
				261)
					# webcam/buero-aussen
					uci set system.@system[0].avoid_autoreboot='true'
				;;
			esac

			_wifi set adhoc any  mcast_rate '6000'

			case "$NODENUMBER" in
				729)
					# mario/xiaomi: prefer 5ghz
					uci set olsrd.@Interface[1].LinkQualityMult='10.63.22.67 0.8'
					uci set olsrd.@Interface[2].LinkQualityMult='10.63.22.67 0.8'
					uci set olsrd.@Interface[3].LinkQualityMult='10.63.22.67 0.8'
				;;
				371)
					# willhelm tell: dont 1hop staatsbank buero
					uci set olsrd.@Interface[1].LinkQualityMult='10.63.80.193 0.7'
				;;
				845)
					# staatsbank buero
					uci set system.@weblogin[0].enabled='0'
					uci set olsrd.@Interface[1].LinkQualityMult='10.63.191.129 0.5'	# dont use bullet directly
				;;
				275)
					# ayse, probs with double IP
					uci set system.@weblogin[0].enabled='0'
				;;
				809)
					# 2.4GHz starfighter/F36 -> staatsbank2
					uci set olsrd.@Interface[1].LinkQualityMult='10.63.96.129 0.5'
				;;
				222)
					# buerocam
					uci set olsrd.@Interface[1].LinkQualityMult='10.63.49.193 0.6'	# SchlachtNanoDach
				;;
				814)
					# schlachtNanoDach (2.4ghz)
					uci set olsrd.@Interface[1].LinkQualityMult='10.63.82.65 0.6'	# Emilio-derZar
				;;
				799)
					# elsternest
					uci set olsrd.@Interface[1].LinkQualityMult='default 0.6'	# dont use wifi!
					config_add_alias 'lan' '192.168.3.1/24'		# ubnt AirOS = 192.168.3.20  / BAMAG
					config_add_alias 'lan' '192.168.1.8/24'		# ubnt AirOS = 192.168.1.222 / ewerk
				;;
				825)
					# BAMAG-to-wagenplatz
					config_add_alias 'wan' '192.168.3.2/24'		# ubnt AirOS = 192.168.3.30
					uci set system.@monitoring[0].pingcheck="$( _ipsystem getvar LANADR 814 )"	# schlachtNanoDach
					uci set system.@monitoring[0].pingcheck_lazy='1'
				;;
				603)
					# ewerk/kesselsaalNEU
# TODO: has issues with lan-dhcp
#					config_add_alias 'lan' '192.168.1.9/24'		# ubnt AirOS = 192.168.1.20
				;;
				813|602)	# frenze/unten/oben
					_wifi set ap 2ghz ssid 'middilgard'
					_wifi set ap 2ghz encryption 'psk2'
					_wifi set ap 2ghz key 'mvemjsunp'
					ROAMING='false'
				;;
			esac

			case "$NODENUMBER" in
				# tobi|tobiAlt|balkon|klaus|alrik|twohl|Ralf-exSchneiderei|roll10|roehr10|martin1200|ute-drucker|zwickau|staatsbank-saal
				813|265|339|823|278|81|863|855|798|836|6|810|862|859)
					uci set system.@weblogin[0].hideandseek='1'
					uci set system.@weblogin[0].auth_type='none'

					case "$NODENUMBER" in
						813)	# tobi/frenze
							uci set system.@monitoring[0].maintenance='reverse_sshtunnel'
							uci set system.@weblogin[0].hideandseek='0'

							# FIXME!
							uci_already_added olsrd Hna4 netaddr '0.0.0.0' || {
								uci add olsrd Hna4 >/dev/null
								uci set olsrd.@Hna4[-1].netaddr='0.0.0.0'
								uci set olsrd.@Hna4[-1].netmask='0.0.0.0'

								pidof olsrd && . /etc/rc.common /etc/init.d/olsrd restart
							}
						;;
						862)
							# zwickau
							uci set system.@weblogin[0].enabled='0'

							good_hash='b78550321eb60cce0f2347905963071c'
							URL='http://intercity-vpn.de/files/kurt_eisner.jpg'
						;;
						863)
							# kleinert
							uci set system.@weblogin[0].enabled='0'

							good_hash='2f89acf6664fb1659cc33cce19c4de28'
							URL='http://www.pension-kleinert-weimar.de/images/kleinert.png'
						;;
						859)
							# staatsbank-saal
							uci set system.@weblogin[0].enabled='0'
						;;
						*)
							good_hash='633f7c77760c44330559ebfe9f040901'
							URL='http://wireless.subsignal.org/images/f/f4/Ww_logo_543.png'
						;;
					esac

					[ "$( _file hash '/www/images/logo.gif' )" = "$good_hash" ] || {
						if [ -e '/www/images/logo-freifunk.gif' ]; then
							mv '/www/images/logo.gif' '/www/images/logo-original.gif'
							mv '/www/images/logo-freifunk.gif' '/www/images/logo.gif'
						else
							DEST='/www/images/logo-freifunk.gif'
							{
								echo "_curl it '$URL' >'$DEST'"
								echo '/etc/init.d/override_uci_vars boot'
								echo '_weblogin generate_prebuilt_splash_htmlfile persistent'
							} >>$SCHEDULER
						fi
					}
				;;
			esac

			case "$NODENUMBER" in
				290)
					# ralf unten
					_wifi set adhoc any mcast_rate '1000'
					_wifi set ap 2ghz ssid 'radio'
					touch "/tmp/vds_user_00:90:3e:fc:81:c2"		# phillips radio

					ROAMING='false'
				;;
				292)
					# ralf oben
					_wifi set adhoc any mcast_rate '1000'
					_wifi set ap 2ghz ssid 'radioquelle'
					uci set system.@monitoring[0].maintenance='reverse_sshtunnel'

					ROAMING='false'
				;;
				276)
					uci set system.@vpn[0].hideandseek_disabled='true'
					uci set network.wan.shaping='true'
					uci set network.wan.shaping_uplink='940'
					uci set network.wan.shaping_downlink='15000'
				;;
				277)
					uci set system.@monitoring[0].button_smstext='Fries36: Knopf gedrueckt: bitte anrufen 03643-827407'
					uci set system.@monitoring[0].button_phone='0176/24223419 0179/7465017'
				;;
				603)
					# ewerk
					_wifi set ap 2ghz ssid 'Mitarbeiter'
					uci set system.@monitoring[0].speedcheck_wired='true'
				;;
			esac

			case "$NODENUMBER" in
				348)
					# TowerPower
					uci set dhcp.lan.ignore=1
				;;
			esac

			case "$NODENUMBER" in
				297)
					# buero2 ethernet -> 297 ethernet -> 222
					uci set olsrd.@Interface[1].LinkQualityMult='10.63.2.1 0.8'
				;;
				276)
#					uci add network interface
#					uci set network.@interface[-1].interface='mytunnel'
#					uci set network.@interface[-1].ifname='tap0'
#					uci set network.@interface[-1].proto='static'
#					uci set network.@interface[-1].ipaddr='10.63.21.93'
#					uci set network.@interface[-1].netmask='255.255.255.252'
#					uci set network.@interface[-1].mtu='1450'
				;;
			esac

			uci set olsrd.@meta[0].hnaslave=0
			apply_olsr_speed 5

			_wifi set adhoc 2ghz ssid 'weimarnetz'
			_wifi set adhoc 2ghz channel '5'
			_wifi set adhoc 2ghz bssid '02:ca:ff:ee:ba:be'

			_wifi set adhoc 5ghz ssid 'weimarnetz-5Ghz'
			_wifi set adhoc 5ghz channel '40'
			_wifi set adhoc 5ghz bssid '02:ca:ff:ee:00:40'
#			_wifi set any   5ghz chanbw '5'

			_wifi longshot name 'BAMAG-wagenplatz' distance 500 channel 100 chanbw 40 mhz mcast 6000 nodes '825 826'
			_wifi longshot name 'f36-schlacht' distance 360 channel 100 chanbw 20 mhz mcast 6000 nodes '719 670'
			_wifi longshot name 'exTobi' distance 500 channel 40 chanbw 20 mhz mcast 6000 nodes '805 806'
			case "$NODENUMBER" in
				826)
					# dumb AP connected ("fritzbox")
					uci set system.@weblogin[0].force_lan_reachable='true'
				;;
				825)
					# BAMAG richtung Wagenplatz (wifi-bridge schlachthof)
					uci set system.@monitoring[0].speedcheck_wired='true'
					uci set system.@monitoring[0].pingcheck='10.63.49.225'
				;;
				814)
					# nano2ghz dach neben elsternetz
					_wifi set adhoc 2ghz mcast_rate '24000'
				;;
				798)
					# roehr10
					_wifi set ap 2ghz ssid 'Weimarnetz'
				;;
				855)
					# rollplatz
					uci set system.@system[0].avoid_autoreboot='true'
					_wifi set ap any ssid 'weimarnetz (C64)'
					_wifi set adhoc 2ghz mcast_rate '1000'
					uci set system.@weblogin[0].hideandseek='1'

					uci set network.wan.shaping_uplink='64'
					uci set network.wan.shaping_uplink='2000'
				;;
				862)
					# zwickauer flitzer
					uci delete 'system.@weblogin[0].authserver'
					_wifi set ap any ssid 'Kurt-Eisner-76'
					_wifi set adhoc any ssid 'o'
					uci set system.@weblogin[0].freelan='false'
					uci set system.@system[0].db_backup_force='true'

					ROAMING='false'
				;;
				806)
					_wifi set adhoc 5ghz bssid '02:ca:ff:ee:00:40'
					# phillip.klein@uni-weimar.de - 0157/88424887
				;;
				x805|x806)
					# TODO: include into longshot()
					uci set wireless.radio0.htmode='NOHT'
					uci set wireless.radio0.beacon_int='250'
				;;
				719|670)
					uci delete 'wireless.radio0.ht_capab'
					uci set wireless.radio0.htmode='HT20'
				;;
				850)
					# demo1
					_wifi set ap 2ghz ssid 'MalchowIT (demo1)'
					uci set system.@monitoring[0].maintenance='reverse_sshtunnel'
					uci set system.@monitoring[0].maintenance_ports='22 80'
					uci set system.@weblogin[0].authserver="$( _ipsystem getvar 'LANADR' '850' )"
					_wifi set adhoc 2ghz ssid 'x'
					uci set system.@weblogin[0].freelan='false'

					ROAMING='false'
				;;
				851)
					# demo2
					_wifi set ap 2ghz ssid 'MalchowIT (demo2)'
					uci set system.@weblogin[0].authserver="$( _ipsystem getvar 'LANADR' '850' )"
					_wifi set adhoc 2ghz ssid 'x'
					uci set system.@weblogin[0].freelan='false'

					ROAMING='false'
				;;
				6|810)
					# ute:drucker/inet
					touch '/tmp/vds_user_00:21:6a:8b:38:76'
					_wifi set adhoc 2ghz mcast_rate '1000'
				;;
				704)
					# sommerbar
					ROAMING='lan wan'
				;;
			esac

			# TODO: test if this speeds up roaming? CoverageClass1 = 450m
			_wifi set any 2ghz distance 100

			[ "$ROAMING" = 'false' ] || {
				apply_olsr_roaming "$ROAMING" && {
					_wifi set ap any ssid 'weimar.freifunk.net'
				}

				_wifi set adhoc 2ghz ssid 'ffintern.2GHz'
				_wifi set adhoc 5ghz ssid 'ffintern.5GHz'
			}

			apply_olsr_watchdog
		;;
		ilm1*)
			uci set system.@vpn[0].hideandseek_disabled='true'
			uci set system.@monitoring[0].statusprecache='true'
			uci set system.@weblogin[0].authserver="$( _ipsystem getvar 'LANADR' '800' )"

			uci set olsrd.@olsrd[0].LinkQualityAlgorithm='etx_ffeth'
			apply_olsr_speed 5

			_wifi set adhoc 2ghz ssid 'x'
			_wifi set adhoc 5ghz ssid 'o'

			case "$NODENUMBER" in
				800)
					_wifi set ap 2ghz ssid 'Ilmstrasse1-Erdgeschoss'
					_wifi set ap 5ghz ssid 'Ilmstrasse1-Erdgeschoss-5GHz'
				;;
				801)
					_wifi set ap 2ghz ssid 'Ilmstrasse1-OG1'
					_wifi set ap 5ghz ssid 'Ilmstrasse1-OG1-5GHz'
				;;
				802)
					_wifi set ap 2ghz ssid 'Ilmstrasse1-OG2'
					_wifi set ap 5ghz ssid 'Ilmstrasse1-OG2-5GHz'
				;;
			esac

			_wifi set ap 5ghz disabled '1'
		;;
		ejbw*)
			[ "$NODENUMBER" = '43' ] || force_dnsserver '208.67.222.123'	# opendns/no_adults

			uci set system.@weblogin[0].enabled='false'		# since 2015nov19

			uci set system.@monitoring[0].ignore_lossyethernet='true'	# powerline e.g. 10.10.31.61
			uci set dhcp.wlan.leasetime='5m'
			uci set olsrd.@meta[0].hnaslave=0
			uci set system.@monitoring[0].backping='16'	# lueftungskeller

			_wifi set adhoc 2ghz bssid '02:be:ef:ca:ff:ee'
			_wifi set ap    2ghz ssid 'EJB Weimar'		# PMR: poor mens roaming

			case "$NODENUMBER" in
				100|101)
					# real: 367m - FIXME! was 20 mhz with r44150/J2 + r41522/reithaus at -70 dBm
					_wifi longshot name 'j2-reithaus' distance 380 channel 104 chanbw 20 mhz mcast 6000 nodes '100 101'
					_wifi set any 5ghz txpower '21'

					uci set network.wlan.shaping='true'
					uci set network.wlan.shaping_uplink='9000'	# we have ~18mbit max @5mhz chanbw (minstrel)
					uci set network.wlan.shaping_downlink='9000'

					uci set system.@weblogin[0].enabled='false'
				;;
			esac

			case "$NODENUMBER" in
				101|41|42|43|45|46)
					# reithaus
					uci set system.@weblogin[0].authserver="$( _ipsystem getvar 'WIFIADR' '100' )"
				;;
				*)
					uci set system.@weblogin[0].authserver='172.17.0.2'
				;;
			esac

			case "$NODENUMBER" in
				39|35|31|30)
					# riegel / pbx
					uci set system.@system[0].avoid_autoreboot='true'
				;;
				43)
					uci set system.@weblogin[0].enabled='1'
					uci set system.@weblogin[0].freelan='1'
				;;
				100)
					uci set dhcp.lan.ignore=1

					config_add_alias 'lan' '192.168.112.2/24' '192.168.112.1'

					[ "$( uci -q get system.@netfilter[0].lan_masquerading )" = '0' ] || {
						uci add system netfilter >/dev/null
						uci set system.@netfilter[-1].lan_masquerading='0'
					}

					uci set system.@monitoring[0].pingcheck='10.10.101.1'
				;;
				101)
#					uci add network alias
#					uci set network.@alias[-1].interface="lan"
#					uci set network.@alias[-1].proto=static
#					uci set network.@alias[-1].ipaddr=192.168.10.2
#					uci set network.@alias[-1].netmask=255.255.255.0
#					uci rename network.@alias[-1]=myLAN

#					uci add network route
#					uci set network.@route[-1].interface="myLAN"
#					uci set network.@route[-1].target=192.168.0.0
#					uci set network.@route[-1].netmask=255.255.255.0
#					uci set network.@route[-1].gateway=192.168.10.1

					uci_already_added olsrd Hna4 netaddr '192.168.10.0' || {
						uci add olsrd Hna4 >/dev/null
						uci set olsrd.@Hna4[-1].netaddr=192.168.10.0
						uci set olsrd.@Hna4[-1].netmask=255.255.255.0
					}

#					uci add olsrd Hna4
#					uci set olsrd.@Hna4[-1].netaddr=192.168.0.0
#					uci set olsrd.@Hna4[-1].netmask=255.255.255.0

					uci set system.@monitoring[0].pingcheck='10.10.100.1'
				;;
			esac
		;;
		leonardo*)
			uci set system.@weblogin[0].namespace='leonardo'	# username of ticket
			uci set system.@weblogin[0].respect_missing_db='true'
			uci set system.@weblogin[0].authserver="$( _ipsystem getvar 'LANADR' '3' )"
			uci set olsrd.@meta[0].hnaslave=0

			_wifi set adhoc 2ghz bssid '02:be:ef:ca:00:11'

			# EG-flur
			case "$NODENUMBER" in
				6|26)
					# FIXME!
					_wifi set anymode anyfreq off
				;;
			esac

			# all wired
			case "$NODENUMBER" in
				2|6|7|9|26|27|35|36)
					uci set system.@system[0].avoid_autoreboot='true'
				;;
			esac

			case "$NODENUMBER" in
				6)
					# master
					uci set system.@monitoring[0].backping='6'
					uci set system.@weblogin[0].allow_wan='true'
					uci set system.@weblogin[0].enabled='0'		# otherwise DNS from wan-side is blocked
					uci set network.wan.public_ip='false'		# since 2014nov10 / primacom
					uci set dhcp.lan.ignore='1'
				;;
				3)
					# konferenz / seems to be NAT'ed sometimes
					uci set system.@monitoring[0].maintenance='reverse_sshtunnel'
					uci set system.@weblogin[0].freelan='1'

					_wifi set ap any ssid 'Leonardo Konferenz'
					ROAMING='false'
				;;
			esac

			apply_olsr_roaming "$ROAMING" && {
				_wifi set ap any ssid 'Hotel Leonardo'
			}
		;;
		malchowit*)
			uci set system.@monitoring[0].maintenance='reverse_sshtunnel'
			uci set system.@monitoring[0].maintenance_ports='22 80'

			uci set system.@system[0].db_backup_force='true'
			uci set system.@weblogin[0].ticketstock='32'

#			apply_olsr_roaming && {
				_wifi set ap any ssid 'Zimmer Mellentin'
#			}
		;;
		malchowpferde*)
			uci set olsrd.@meta[0].allow_no_neigh='true'
			uci set system.@monitoring[0].maintenance='reverse_sshtunnel'
			uci set system.@monitoring[0].maintenance_ports='22 80'
			uci set system.@system[0].db_backup_force='true'

			config_add_alias 'wan' '192.168.2.253/24'	# portfw
		;;
		malchowpension*)
			uci set olsrd.@meta[0].allow_no_neigh='true'
			uci set system.@weblogin[0].auth_type='roomnumber'
			uci set system.@monitoring[0].maintenance='reverse_sshtunnel'
			uci set system.@monitoring[0].maintenance_ports='22 80'
			uci set system.@system[0].db_backup_force='true'

			_wifi set ap 2ghz ssid 'Fackelgarten'
			_wifi set ap 5ghz ssid 'Fackelgarten Konferenz'
		;;
		tkolleg*)
			uci set system.@system[0].db_backup_force='true'
			uci set olsrd.@meta[0].hnaslave=0
			uci set system.@timeserver[0].server='10.10.0.1'
			uci set system.@weblogin[0].freelan='1'

			[ "$NODENUMBER" = '2' ] && {
				uci set network.lan.netmask='255.255.0.0'
				uci set network.lan.gateway='10.10.0.1'

				uci del      dhcp.@dnsmasq[0].server
				uci add_list dhcp.@dnsmasq[0].server='10.10.0.1'
				# olsrd-hna: 0/0 + 10.10.0.1/32 + 10.10.0.2/32 + 10.10.0.10/32
			}
		;;
		giancarlo*)
			case "$NODENUMBER" in
				20)	# nudeltheke
					uci set system.@monitoring[0].pingcheck='10.10.5.129'
					uci set system.@monitoring[0].pingcheck_lazy='1'
				;;
				5)
					uci set system.@system[0].avoid_autoreboot='true'
				;;
			esac

			uci set system.@monitoring[0].ignore_lossyethernet='true'	# FIXME!
			uci set system.@weblogin[0].authserver="$( _ipsystem getvar 'LANADR' '5' )"
			uci set system.@weblogin[0].respect_missing_db='true'

			apply_olsr_roaming && {
				_wifi set ap any ssid 'Giancarlo'
			}

			_wifi set adhoc 2ghz ssid 'intern.2GHz'
#			_wifi set adhoc 2ghz disabled 'true'

			uci set system.@monitoring[0].wifi_netparam_name='wlanadhocRADIO1'

			_wifi set any   5ghz chanbw '5'
			_wifi set any   5ghz channel '104'
			_wifi set any   5ghz txpower '21'
			_wifi set adhoc 5ghz ssid 'intern.5GHz'

			_wifi set adhoc 2ghz mcast_rate '6000'
			_wifi set ap    5ghz disabled 'true'
		;;
		marinabh*)
			uci set system.@monitoring[0].backping='9'	# steg2laterne-AP
			uci set system.@weblogin[0].authserver="$( _ipsystem getvar 'LANADR' '2' )"
			[ "$NODENUMBER" = "2" ] && _wifi set any any disabled '1'
			uci set olsrd.@meta[0].hnaslave=0

			apply_olsr_roaming && {
				_wifi set ap any ssid 'Marina Boltenhagen'
			}

			_wifi set adhoc 2ghz ssid 'intern.2GHz'
			_wifi set adhoc 5ghz ssid 'intern.5GHz'
			_wifi set adhoc 2ghz mcast_rate '12000'
		;;
		adagio*)
			uci set olsrd.@meta[0].hnaslave=0

			_wifi set adhoc 2ghz channel '11'
			_wifi set adhoc 2ghz bssid '02:ca:ff:ee:00:11'

			_wifi set adhoc 2ghz mcast_rate '6000'		# prefer 5ghz TODO: penalty for 2ghz OLSR?
			_wifi set adhoc 5ghz mcast_rate '6000'

			apply_olsr_roaming "$ROAMING" && {
				_wifi set ap any ssid 'Hotel Adagio'
			}
		;;
		lisztwe*)
			uci set olsrd.@meta[0].hnaslave=0

			_wifi set adhoc any mcast_rate '6000'

			apply_olsr_roaming "$ROAMING" && {
				_wifi set ap any ssid 'Hotel Liszt'
			}
		;;
		rehungen*)
			uci set system.@weblogin[0].authserver="$( _ipsystem getvar 'LANADR' '8' )"
			uci set system.@monitoring[0].ignore_switch_error='true'
			uci set system.@weblogin[0].respect_missing_db='true'
			uci set system.@weblogin[0].freelan='1'
			uci set olsrd.@meta[0].fixedarp='1'
			uci set system.@weblogin[0].logtraffic='1'
			uci set system.@monitoring[0].backping='8'	# kiga

			# NetIO230b/Kiga  - 24:a4:2c:10:17:fa
			# NetIO230b/Puppe - 24:a4:2c:10:02:a6
			uci set system.@weblogin[0].dynamic_portfw='24:a4:2c:'

			_wifi set adhoc 2ghz mcast_rate '6000'

			case "$NODENUMBER" in
				8)
					# till will we fix 230/232
					uci set system.@monitoring[0].ignore_lossyethernet='true'
				;;
				89|131|44|72)
					# FIXME!
					# klausgasse66a-dach|klausgasse101b-dach|nussberg2b-dachstube
					_wifi set adhoc 2ghz mcast_rate '1000'
				;;
				63)
					# hauptstrasse 114 unten
					uci set system.@monitoring[0].pingcheck='10.10.254.33'
				;;
				113)
					# hostname = kirchgasse34kinderzimmer-unten
					# nexthop = node5 = hauptstrasse40b-NEU2
					# lanmac seen: 70:1a:04:b1:e6:40
					uci set system.@weblogin[0].blocked='true'
				;;
				249)
					# feld -> rehungen
					uci set system.@monitoring[0].ignore_lossyethernet='true'
					uci set olsrd.@meta[0].reboot_weak_ethernet='0'
				;;
				250)
					# feld -> sollstedt
					uci set system.@monitoring[0].ignore_lossyethernet='false'
					uci set olsrd.@meta[0].reboot_weak_ethernet='1'
					uci set system.@monitoring[0].pingcheck='10.10.249.1'
				;;
				254)
					uci set system.@system[0].avoid_autoreboot='true'
					uci set system.@weblogin[0].blocked='true'
					uci set system.@monitoring[0].pingcheck='10.10.8.33'
					_wifi set any any disabled '1'
				;;
				253)
					uci set system.@monitoring[0].pingcheck='8.8.8.8'
				;;
				248)
					# kiga/bullet5m -> konsum/193
#					uci set olsrd.@Interface[1].LinkQualityMult='10.10.193.1 0.7'
				;;
				193)
					# konsum/bullet5m -> feld/237
#					uci set olsrd.@Interface[1].LinkQualityMult='10.10.237.1 0.7'
				;;
			esac

			_wifi set adhoc 2ghz bssid '02:be:ef:ca:ff:ee'
			_wifi set ap    2ghz  ssid "Rehungen $NODENUMBER"

			# TODO: sort nodenumber-order <-> hostname
			# distance: roundup to 50m
			_wifi longshot name 'heidenroder-thalmann'  distance  100 channel 157 chanbw 20 mhz mcast 18000 nodes '253 252'

			_wifi longshot name 'feld-soll'             distance 3100 channel  48 chanbw 20 mhz mcast 18000 nodes '251 250'
			_wifi longshot name 'feld-kiga'             distance  950 channel 165 chanbw 20 mhz mcast 18000 nodes '249 248 237 193'

			_wifi longshot name 'kiga-kirchg40b'        distance  200 channel  36 chanbw 20 mhz mcast  6000 nodes '236'		# nolink
			# FIXME! it's the same like puppe-breitestr14/218?
			_wifi longshot name 'kiga-hauptstr25'       distance  500 channel  36 chanbw  5 mhz mcast  6000 nodes '234'		# nolink
			_wifi longshot name 'kiga-kirchg38'         distance  400 channel  36 chanbw 20 mhz mcast  6000 nodes '232'		# nolink
			_wifi longshot name 'kiga-klausg70'         distance  200 channel 161 chanbw 20 mhz mcast 18000 nodes '230 229'
			_wifi longshot name 'kiga-kirchg33'         distance  150 channel 153 chanbw 20 mhz mcast 18000 nodes '228 227'
#			_wifi longshot name 'kiga-klausg67b3'       distance  350 channel  40 chanbw 20 mhz mcast  6000 nodes '212'		# nolink
			_wifi longshot name 'kiga-dietzelsg39b'     distance  200 channel  36 chanbw 20 mhz mcast  6000 nodes '224'		# nolink
			_wifi longshot name 'kiga-nussberg116/73a'  distance  350 channel  40 chanbw 20 mhz mcast 18000 nodes '222 221 212'	# 223 missing = kiga - now 212
			# 214=kiga 213=puppe 188=nussberg79a 190=haupt8 +dazu: 189/haupt14neu + 247/breite14
			_wifi longshot name 'kiga-puppe'            distance  400 channel  60 chanbw 20 mhz mcast 18000 nodes '214 213 188 190 189 247'

			# 189=haupt14neu
#			_wifi longshot name 'puppe-hauptstr14-br1'  distance  250 channel 153 chanbw 20 mhz mcast 18000 nodes '220 219 247 189'
			_wifi longshot name 'puppe-breitestr14'     distance  300 channel  36 chanbw 20 mhz mcast  6000 nodes '218'		# nolink
			_wifi longshot name 'puppe-schuetzeng'      distance  250 channel 112 chanbw  5 mhz mcast  6000 nodes '216 215 210'

			_wifi longshot name 'kirchg33-hauptstr52'   distance  200 channel 149 chanbw 20 mhz mcast 18000 nodes '226 225'
#			_wifi longshot name 'klaus101b-klausg67b3'  distance  200 channel  36 chanbw 20 mhz mcast  6000 nodes '201 203'		# 201 missing
			_wifi longshot name 'klaus101b-klausg67b3'  distance 1200 channel  48 chanbw 20 mhz mcast  6000 nodes '201 203'		# 201 missing -> feld/249?

			_wifi longshot_name >/dev/null && {
				uci set system.@system[0].avoid_autoreboot='true'
				uci set olsrd.@meta[0].reboot_weak_ethernet='true'
			}

			uci set system.@monitoring[0].nightly_longrange='true'
		;;
		boltenhagendh*)
			uci set system.@monitoring[0].maxcost='6500'
			uci set system.@monitoring[0].ignore_lossyethernet='true'	# too much restarting OLSR/fully wired switched
			uci set system.@weblogin[0].authserver="$( _ipsystem getvar 'LANADR' '111' )"		# Festscheune3
			uci set system.@weblogin[0].always_reachable='true'

			uci set olsrd.@meta[0].hnaslave='0'
			uci set olsrd.@meta[0].throttle_traffic='1'

			apply_olsr_speed '20'

			case "$NODENUMBER" in
				159|139)
					# LobbyBar IB/WZR + surfstation DH
					uci set dhcp.lan.ignore='0'
				;;
				*)
					uci set dhcp.lan.ignore='1'
				;;
			esac

			case "$NODENUMBER" in
				111|2)
					# festscheune3/authserver + master
					uci set system.@monitoring[0].report_traffic_nightly='true'
					uci set system.@system[0].avoid_autoreboot='true'
					uci set system.@monitoring[0].ignore_load='true'

					_wifi set any any disabled '1'		# no wifi
				;;
			esac

			case "$NODENUMBER" in
				2)
					uci set network.wan.shaping='true'
					uci set network.wan.shaping_uplink='9500'
					uci set network.wan.shaping_downlink='9500'
				;;
			esac

			_wifi set adhoc 2ghz bssid '02:be:ef:ca:ff:ee'
			_wifi set adhoc 2ghz channel '11'

			case "$NODENUMBER" in
				138|139|200|168|170)
					# serverraum/surfstation DH
					_wifi set adhoc 2ghz mcast_rate '1000'
				;;
#				33|34|35|36|37|38|39|40|41|42|43|44)
#					# haus 1
#					uci set olsrd.@meta[0].hnaslave=1
#					uci set olsrd.@meta[0].hnaslave_dirty='true'
#				;;
			esac

			if [ -e '/www/hnaslave_dirty' ]; then
				uci set olsrd.@meta[0].hnaslave=1
				uci set olsrd.@meta[0].hnaslave_dirty='true'
			else
				uci set olsrd.@meta[0].hnaslave=1
				uci set olsrd.@meta[0].hnaslave_dirty='true'

				# 2 = nexthop and 'AP-only'
				uci set olsrd.@meta[0].hnaslave_condition='2 ap'
			fi

			_wifi set adhoc 2ghz ssid 'intern.2GHz'
			_wifi set adhoc 5ghz ssid 'intern.5GHz'

			apply_olsr_roaming "$ROAMING" && {
				_wifi set ap any ssid 'Weisse Wiek'
			}

			case "$NODENUMBER" in
				# FS: Schliemann | Konferenz | Lilienthal | Serverraum | Barlach
				# 7 war Konferenz -> putt (Barlach nun Konferenz), Barlach nun 8
				# 203-206 = 4 x zusatz
				157|81|7|8|174|175|176|203|204|205|206)
					uci set system.@weblogin[0].enabled='0'
					uci set olsrd.@meta[0].hnaslave='0'

					local UNIX_NOW="$( _system date unixtime )"
					local UNIX_START="$( _system date 2unixtime 'Sun Aug 23 23:55:00 CET 2015' )"	# 23.8
					local UNIX_END="$(   _system date 2unixtime 'Wed Sep  7  3:55:00 CET 2015' )"	# 6.9
					[ $UNIX_NOW -gt $UNIX_START -a $UNIX_NOW -lt $UNIX_END ] && {
						_wifi set ap any ssid 'NRV'
					}
				;;
			esac
		;;
		spbansin*)
			uci set system.@weblogin[0].respect_missing_db='true'
			uci set system.@weblogin[0].authserver="$( _ipsystem getvar 'LANADR' '4' )"
			uci set system.@weblogin[0].auth_type='roomnumber'
			uci set olsrd.@meta[0].hnaslave='0'

			case "$HARDWARE" in
				'Ubiquiti Bullet'*)
					uci set network.lan.force_link='1'
				;;
			esac

			if apply_olsr_roaming "$ROAMING"; then
				_wifi set ap any ssid 'SEEPARK'
			else
				_wifi set ap 5ghz ssid "Seepark$NODENUMBER-5"
				_wifi set ap 2ghz ssid "Seepark$NODENUMBER"
			fi

			_wifi set adhoc 5ghz ssid 'a'
			_wifi set adhoc 2ghz ssid 'g'
		;;
		schoeneck*)
			_wifi set any 2ghz distance 100

			uci set system.@weblogin[0].db_cachesize='6000'
			uci set system.@weblogin[0].dynamic_portfw='24:a4:2c:10:21:48'		# NetIO230b/Keller

			uci set system.@weblogin[0].respect_missing_db='true'
			uci set system.@monitoring[0].ignore_switch_error='true'

			uci set olsrd.@meta[0].fixedarp='1'
			uci set olsrd.@meta[0].hnaslave=0

			_wifi set ap    2ghz txpower '15'
			_wifi set ap    2ghz ssid "IFA Schoeneck $NODENUMBER"
			_wifi set ap    5ghz disabled '1'			# !!!
			_wifi set adhoc 2ghz bssid '02:ca:ff:ee:00:11'
			_wifi set adhoc 2ghz channel '11'
			_wifi set adhoc 2ghz ssid 'x'
			_wifi set adhoc 2ghz mcast_rate '6000'

			case "$NODENUMBER" in
				228|230|234|231|235|232|229|233)
					# all switched together, netio230b on master
					uci set dhcp.lan.ignore=1
				;;
				2)
					_wifi set any any disabled '1'

					# DHCP is 192.168.2.107 / gateway = 192.168.2.1
					config_add_alias 'wan' '192.168.2.108/24'
				;;
			esac

			apply_olsr_roaming "$ROAMING" && {
				_wifi set ap any ssid 'IFA Ferienpark'
			}
		;;
		*)
			# TODO: does not work anymore - at least with r43080
			# enforce b43-hack
			[ -e "/lib/modules/$( uname -r )/b43.ko" ] && {
				local file="/lib/wifi/mac80211.sh"
				local keyword="keyspec}"	# must be at the end of a line
				local command1='config_get bitrates "$device" bitrates'
				local command2='test -n "$bitrates" \&\& iw dev "$ifname" set bitrates legacy-2.4 $bitrates'

				[ "$( uci -q get wireless.@wifi-iface[0].mode )" = "adhoc" ] && {
					[ -n "$( uci -q get wireless.radio0.bitrates )" ] || {
						uci set wireless.radio0.bitrates="6 9 12 18 24 36 48 54"

						case "$( uci -q get wireless.@wifi-iface[0].mcast_rate )" in
							1000|2000|5500|11000)
								uci delete 'wireless.@wifi-iface[0].mcast_rate'
							;;
						esac
					}

					grep -q "$keyword"$ "$file" && {
						sed -i "s/$keyword$/$keyword ; $command1 ; $command2 /" "$file"
					}
				}
			}
		;;
	esac

	case "$HARDWARE" in
		"Buffalo WHR-HP-G54")
			case "$( uci -q get wireless.radio0.rxantenna )-$( uci -q get wireless.radio0.txantenna )" in
				"1-1")
				;;
				*)
					uci set wireless.radio0.rxantenna=1
					uci set wireless.radio0.txantenna=1
					_log it uci_commit daemon alert 'wireless: changed antenna settings'
					uci commit wireless
				;;
			esac
		;;
		"Linksys WRT54G"*)
			case "$( uci -q get wireless.radio0.rxantenna )-$( uci -q get wireless.radio0.txantenna )" in
				"0-0")
				;;
				*)
					uci set wireless.radio0.rxantenna=0
					uci set wireless.radio0.txantenna=0
					_log it uci_commit daemon alert 'wireless: changed antenna settings'
					uci commit wireless
				;;
			esac
		;;
		"TP-LINK TL-WR1043ND")
			# use driver defaults
			case "$CONFIG_PROFILE" in
				liszt28*)
					# dont touch
				;;
				*ap)
					# dont touch
				;;
				*)
					uci -q get wireless.radio0.txpower && uci delete 'wireless.radio0.txpower'
				;;
			esac
		;;
	esac

	case "$( uci -q get wireless.radio0.hwmode )" in
		*'n'*)
			if _wifi longshot_name >/dev/null ; then
				:
				# dont touch, wifi_longshot() sets it
			else
				# 802.11n works with distributed beaconing
				uci set wireless.radio0.beacon_int=100
			fi
		;;
	esac

	case "$( uci -q get wireless.radio0.htmode )" in
		'HT40'*)
			uci set wireless.radio0.noscan="1"
		;;
	esac

	# fix for forgotten network
	case "$CONFIG_PROFILE" in
		*hybrid)
			grep -q "wlanadhoc" "/etc/config/wireless" && {
				uci show network | grep -q ^"network.wlanadhoc=" || {
					uci set network.wlanadhoc=interface
					uci set network.wlanadhoc.proto=static
					uci set network.wlanadhoc.ipaddr=$(  uci get network.wlan.ipaddr )
					uci set network.wlanadhoc.netmask=$( uci get network.wlan.netmask )
				}
			}
		;;
	esac

	# specials for testnetwork
	case "$CONFIG_PROFILE" in
		liszt28*)
			[ -h '/www/webcam.jpg' ] && {
				uci show system | grep -q 'webcam' || {
					uci add system webcam >/dev/null
					uci set system.@webcam[-1].storage_path='bastian@10.63.2.34:bigbrother/'
				}
			}


			case "x-$NODENUMBER" in
				99)
					uci set olsrd.@meta[0].watch_ip='10.63.2.25'
					uci set olsrd.@meta[0].watch_value='2000'
				;;
				2)
					uci set olsrd.@meta[0].watch_ip='10.63.76.1'
					uci set olsrd.@meta[0].watch_value='3000'
				;;
				112)
					uci set olsrd.@meta[0].watch_ip='10.63.6.1'
					uci set olsrd.@meta[0].watch_value='3000'
				;;
				6)
					uci set olsrd.@meta[0].watch_ip='10.63.112.1'
					uci set olsrd.@meta[0].watch_value='3000'
				;;
				10)
					uci set olsrd.@meta[0].watch_ip='10.63.6.3'
					uci set olsrd.@meta[0].watch_value='2000'
				;;
			esac
		;;
	esac

	batman_kmodules_are_deactivated()
	{
		kmodule_is_deactivated 'batman-adv'
	}

	batman_kmodules_force_activation()
	{
		kmodule_force_activation 'batman-adv'
		kmodule_force_activation 'ebtables'
#		kmodule_force_activation 'macvlan'
	}

	batman_kmodules_force_deactivation()
	{
		kmodule_force_deactivation 'batman-adv'
		kmodule_force_deactivation 'ebtables'
#		kmodule_force_deactivation 'macvlan'
	}

	batman_needed()
	{
		[ -e '/usr/sbin/batctl' ] || return 1

		case "$CONFIG_PROFILE" in
			testbatman*)
				return 0
			;;
			*)
				batman_kmodules_are_deactivated || batman_kmodules_force_deactivation
				return 1
			;;
		esac
	}

	if batman_needed; then
		uci set batman-adv.bat0.orig_interval=1000	# default = 1000 ms

		local file='/etc/init.d/dnsmasq'
		fgrep -q 'netmask_dhcpcalc' "$file" || {
			sed -i 's/start$/&; local netmask_dhcpcalc; config_get netmask_dhcpcalc "$cfg" netmask_dhcpcalc/' "$file"
			sed -i 's/ $netmask / ${netmask_dhcpcalc:-$netmask} /' "$file"
			sed -i 's/,$NETMASK,/,$netmask,/' "$file"
			# since r39101 needed:
			sed -i 's/eval \(.*\)/&\n	test "$PREFIX" = "${netmask_dhcpcalc:-$netmask}" \&\& netmask="$NETMASK"/' "$file"
		}

		fgrep " \"\$dynamicdhcp\" = \"0\" " "$file" | fgrep -q 'test' || {
			sed -i "s/.* \"\$dynamicdhcp\" = \"0\" .*/& ; test \"\$START\" = '192.168.0.2' \&\& START='192.168.$NODENUMBER.2'; test \"\$END\" = '192.168.0.254' \&\& END='192.168.$NODENUMBER.254'/" "$file"
		}

		batman_kmodules_are_deactivated && batman_kmodules_force_activation
	else
#		batman_kmodules_are_deactivated || batman_kmodules_force_deactivation

		case "$CONFIG_PROFILE" in
			*ap|*hybrid)
				uci set dhcp.wlan.ignore=0
			;;
		esac
	fi

	batman_needed && {
		local dns_ip i
		local router_ip="192.168.$NODENUMBER.1"
		local master_gateway

		case "$CONFIG_PROFILE" in
			testnet*)
				router_ip="192.168.0.1"		# every router has this ip (there is never a NODE 0)
				master_gateway="192.168.99.1"
				dns_ip="$router_ip"
			;;
		esac

		local startup="/tmp/WIFI_SPECIALS.sh"

		set_mac()
		{
			local uci_path="$1"
			local mac="$2"
			local file='/www/monitoring.wifimac'

			if [ -e "$file" ]; then
				uci set "$uci_path"="$mac"
			else
				uci delete "$uci_path"
			fi
		}

		batalias_add_if_needed()
		{
			local ifname_ask="$1"
			local ifname proto i mac index channel

			for i in $(seq 0 100); do {
				proto="$( uci -q get network.@alias[${i}].proto )" || continue

				case "$proto" in
					'batadv')
						ifname="$( uci -q get network.@alias[${i}].interface )"
						[ "$ifname_ask" = "$ifname" ] && {
							uci delete "network.@alias[$i]"
						}
					;;
				esac
			} done

			# FIXME! dont add twice
			uci add network alias >/dev/null
			uci set network.@alias[-1].interface="$ifname_ask"
			uci set network.@alias[-1].proto=batadv
			uci set network.@alias[-1].mesh=bat0

			case "$ifname_ask" in
				'lan'|'wan')
					case "$ifname_ask" in
						'lan')
							mac="02:00:ca:b1:$( integer2fourhex "$NODENUMBER" )"
						;;
						'wan')
							mac="02:00:de:ad:$( integer2fourhex "$NODENUMBER" )"
						;;
					esac

					set_mac "network.$ifname_ask.macaddr" "$mac"
				;;
				'wlan'*)
					# e.g. wlan | wlanadhoc | wlanadhocRADIO1
					index="$( _wifi get "$ifname_ask" index )" && {
						channel="$( _wifi get "$ifname_ask" channel )"
						mac="ca:$( integer2fourhex "$channel" ):00:$( integer2fourhex "$NODENUMBER" )"

						set_mac "wireless.@wifi-iface[$index].macaddr" "$mac"
					}
				;;
			esac

			{
				echo "DEVNAME=\$( ifstatus \"$ifname_ask\" | grep '\"device\":' | cut -d'\"' -f4 )"
				echo "batctl interface | grep -q ^\"\$DEVNAME: active\" || batctl if add \$DEVNAME"
			} >>"$startup"
		}

		# the first added interface is our originator-address (mac)
		batalias_add_if_needed 'lan'

		uci -q get network.wan >/dev/null && {
			# fixme! ejbw needs an override
			case "$( _net local_inet_offer )" in
				'wan'|'pppoe')
					echo >>"$startup" "# wan not added, because local inet-offer"
				;;
				*)
					batalias_add_if_needed 'wan'
				;;
			esac
		}

		local index mac

		# ifname = macaddress:
		# bridge = 02:00:b0:0b:$nodenumber
		# gw0    = 02:00:c0:ca:c0:1a
		#
		# lan    = 02:00:ca:b1:$nodenumber
		# wan    = 02:00:de:ad:$nodenumber
		# ap1    = 02:00:0a:00:$nodenumber
		# ap2    = 02:00:0b:00:$nodenumber
		# adhocX = ca:$chan:00:$nodenumber

		# fixme! iterate over all wifi-interfaces, e.g. 'add adhoc any/5ghz'
		case "$CONFIG_PROFILE" in
			*'_hybrid')
				_wifi get 'wlanadhoc'       check && batalias_add_if_needed 'wlanadhoc'
				_wifi get 'wlanadhocRADIO1' check && batalias_add_if_needed 'wlanadhocRADIO1'

				# first AP
				index="$( _wifi get 'wlan' index )" && {
					mac="02:00:0a:00:$( integer2fourhex "$NODENUMBER" )"
					set_mac "wireless.@wifi-iface[$index].macaddr" "$mac"
				}

				# second AP
				index="$( _wifi get 'wlanRADIO1' index )" && {
					mac="02:00:0b:00:$( integer2fourhex "$NODENUMBER" )"
					set_mac "wireless.@wifi-iface[$index].macaddr" "$mac"
				}
			;;
			*'_adhoc')
				_wifi get 'wlan' check && batalias_add_if_needed 'wlan'
			;;
			*'_ap')
				# first AP
				index="$( _wifi get 'wlan' index )" && {
					mac="02:00:0a:00:$( integer2fourhex "$NODENUMBER" )"
					set_mac "wireless.@wifi-iface[$index].macaddr" "$mac"
				}
			;;
		esac

		case "$CONFIG_PROFILE" in
			*hybrid)
				for i in $(seq 0 15); do {
					[ "$( uci -q get wireless.@wifi-iface[$i].mode )" = "ap" ] && {
						echo "NAME=\"\$( uci get wireless.@wifi-iface[$i].network )\""
						echo "DEV=\$( ifstatus \"\$NAME\" | grep '\"device\":' | cut -d'\"' -f4 )"
						echo "_log it batman daemon info \"$startup: adding DEV \$DEV to br-mybridge\""
						echo "brctl addif br-mybridge \$DEV"
					} >>"$startup"
				} done
			;;
			*ap)
				{
					echo "_log it batman daemon info \"$startup: adding DEV wlan0 to br-mybridge\""
					echo "brctl addif br-mybridge wlan0"
					echo "brctl addif br-mybridge wlan1	# dirty: simply fails if n/a"
				} >>"$startup"
			;;
		esac

#		echo "dnsmasq --address=/#/10.63.$NODENUMBER.1 -p 5353" >>"$startup"

		uci set network.mybridge="interface"
		uci set network.mybridge.type="bridge"
		uci set network.mybridge.ifname="bat0"
		uci set network.mybridge.macaddr="02:00:b0:0b:$( integer2fourhex "$NODENUMBER" )"
		uci set network.mybridge.proto="static"
		uci set network.mybridge.ipaddr="192.168.$NODENUMBER.1"
		uci set network.mybridge.netmask="255.255.0.0"
		uci set network.mybridge.netmask_dhcpcalc="255.255.255.0"

		# https://lists.open-mesh.org/pipermail/b.a.t.m.a.n/2013-November/010913.html
		local mac_gateway="02:00:c0:ca:c0:1a"
		command -v ebtables >/dev/null && {
			echo "ebtables -A FORWARD -j DROP -d '$mac_gateway'"
			echo "ebtables -t nat -A POSTROUTING -o bat0 -j DROP -s '$mac_gateway'"
			echo "#  query via: ebtables -L FORWARD --Lc; ebtables -t nat -L POSTROUTING --Lc"
		} >>"$startup"

		case "$CONFIG_PROFILE" in
			*_adhoc)
			;;
			liszt28*|schoeneck*|boltenhagendh*|apphalle*)
				# depends on kmod-macvlan
				{
					echo "_log it batman daemon info \"$startup: forcing gateways ip/mac: $router_ip/$mac_gateway\""
					echo "ip link add link 'br-mybridge' 'gateway0' address '$mac_gateway' type macvlan"
					echo "ip address add $router_ip/32 dev gateway0"
					echo "ip link set dev gateway0 up"
				} >>"$startup"
			;;
		esac

		case "$CONFIG_PROFILE" in
			*_adhoc|*_hybrid)
				uci set batman-adv.bat0.bridge_loop_avoidance=1
			;;
		esac

		# every node is a server, which means: answer DHCP locally
		if [ "$( uci -q get network.mybridge.ipaddr )" = "$master_gateway" ]; then
			uci set batman-adv.bat0.gw_mode=server
			uci set batman-adv.bat0.gw_bandwidth="16384kbit/16384kbit"
		else
			uci set batman-adv.bat0.gw_mode=server
			uci set batman-adv.bat0.gw_bandwidth="512kbit/512kbit"

			case "$CONFIG_PROFILE" in
				schoeneck*|boltenhagendh*|apphalle*)
					# no l3-routing proto running, so we need a fix master-gateway
					uci set network.mybridge.gateway="$master_gateway"
					uci set system.@weblogin[0].authserver="$master_gateway"
				;;
			esac
		fi

		uci set dhcp.mybridge=dhcp
		uci set dhcp.mybridge.interface=mybridge
		uci set dhcp.mybridge.start=2
		uci set dhcp.mybridge.limit=253
		uci set dhcp.mybridge.leasetime=12h
		uci set dhcp.mybridge.force=1
		uci set dhcp.mybridge.ignore=0
		uci set dhcp.mybridge.netmask=255.255.0.0
		uci set dhcp.mybridge.dhcp_option="option:router,$router_ip,$dns_ip"	# fixme! dynamic set during runtime
		uci set dhcp.mybridge.leasetime=10m

		uci set dhcp.wlan.ignore=1
	}
}
